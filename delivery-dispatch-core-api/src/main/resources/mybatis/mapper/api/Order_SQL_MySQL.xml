<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="kr.co.cntt.core.mapper.OrderMapper">

    <!-- selectRidersResult -->
    <resultMap id="selectOrdersResult" type="kr.co.cntt.core.model.order.Order">
        <result property="id" column="id" />
        <result property="regOrderId" column="reg_order_id" />
        <result property="createdDatetime" column="created_datetime" />
        <result property="storeId" column="store_id" />
        <result property="riderId" column="rider_id" />
        <result property="address" column="address" />
        <result property="detailAddress" column="detail_address" />
        <result property="status" column="status" />
        <result property="menuName" column="menu_name" />
		<result property="menuPrice" column="menu_price" />
		<result property="assignedFirst" column="assigned_first" />
		<result property="deliveryPrice" column="delivery_price" />
		<result property="totalPrice" column="total_price" />
        <result property="cookingTime" column="cooking_time" />
        <result property="paid" column="paid" />
        <result property="reservationDatetime" column="reservation_datetime" />
        <result property="assignedDatetime" column="assigned_datetime" />
        <result property="pickedUpDatetime" column="picked_up_datetime" />
		<result property="completedDatetime" column="completed_datetime" />
        <result property="returnDatetime" column="return_datetime" />
		<result property="combinedOrderId" column="combined_order_id" />
		<result property="latitude" column="latitude" />
		<result property="longitude" column="longitude" />
		<result property="count" column="count" />
		<result property="phone" column="phone" />
		<result property="message" column="message" />

        <association property="rider" column="rider" javaType="kr.co.cntt.core.model.rider.Rider">
            <result property="id" column="rider_id" />
            <result property="name" column="rider_name" />
        </association>

		<association property="store" column="store" javaType="kr.co.cntt.core.model.store.Store">
			<result property="id" column="store_id" />
			<result property="adminId" column="admin_id" />
			<result property="storeName" column="store_name" />
			<result property="latitude" column="store_latitude" />
			<result property="longitude" column="store_longitude" />
			<result property="radius" column="radius" />
			<result property="assignmentLimit" column="assignment_limit" />
			<result property="storeDistanceSort" column="store_distance_sort" />
		</association>
    </resultMap>


	<!-- selectRiderResult -->
	<resultMap id="selectOrderInfoResult" type="kr.co.cntt.core.model.order.Order">
		<result property="id" column="id" />
		<result property="regOrderId" column="reg_order_id" />
		<result property="createdDatetime" column="created_datetime" />
		<result property="status" column="status" />
		<result property="storeId" column="store_id" />
		<result property="riderId" column="rider_id" />
		<result property="address" column="address" />
		<result property="detailAddress" column="detail_address" />
		<result property="latitude" column="latitude" />
		<result property="longitude" column="longitude" />
		<result property="menuName" column="menu_name" />
		<result property="menuPrice" column="menu_price" />
		<result property="deliveryPrice" column="delivery_price" />
		<result property="totalPrice" column="total_price" />
		<result property="cookingTime" column="cooking_time" />
		<result property="paid" column="paid" />
		<result property="message" column="message" />
		<result property="phone" column="phone" />
		<result property="reservationDatetime" column="reservation_datetime" />
		<result property="assignedDatetime" column="assigned_datetime" />
		<result property="pickedUpDatetime" column="picked_up_datetime" />
		<result property="completedDatetime" column="completed_datetime" />
        <result property="returnDatetime" column="return_datetime" />
		<result property="combinedOrderId" column="combined_order_id" />
		<result property="device_os" column="device_os" />

		<association property="rider" column="rider" javaType="kr.co.cntt.core.model.rider.Rider">
			<result property="id" column="rider_id" />
			<result property="name" column="rider_name" />
		</association>

		<association property="store" column="store" javaType="kr.co.cntt.core.model.store.Store">
			<result property="id" column="store_id" />
			<result property="storeName" column="store_name" />
			<result property="storeRealName" column="store_real_name" />
			<result property="latitude" column="store_latitude" />
			<result property="longitude" column="store_longitude" />
			<result property="longitude" column="store_longitude" />
			<result property="address" column="store_address" />
			<result property="detailAddress" column="store_detail_address" />
			<result property="storeDistanceSort" column="store_distance_sort" />
		</association>
	</resultMap>

	<resultMap id="selectReservationOrdersResult" type="kr.co.cntt.core.model.order.Order">
		<result property="id" column="id" />
		<result property="adminId" column="admin_id" />
		<result property="storeId" column="store_id" />
		<result property="riderId" column="rider_id" />

		<association property="subGroup" column="subGroup" javaType="kr.co.cntt.core.model.group.SubGroup">
			<result property="id" column="subgroup_id" />
		</association>
	</resultMap>

	<!-- insertOrder -->
    <insert id="insertOrder" parameterType="kr.co.cntt.core.model.order.Order">
		INSERT INTO TB_ORDER (
			admin_id
			, store_id
			, address
			, area_address
			, district_address
			, street_address
			, estate_address
			, building_address
			, detail_address
			, latitude
			, longitude
			, cooking_time
			, menu_name
			, menu_price
			, delivery_price
			, total_price
			, paid
			, message
			, phone
			, reservation_datetime
			, device_os
			, status
			, reg_order_id
			, web_order_id
			, created_datetime
		) VALUES(
			(SELECT admin_id FROM TB_STORE WHERE id = (SELECT store_id FROM TB_STORE_SESSION WHERE access_token = #{token}))
			, (SELECT store_id FROM TB_STORE_SESSION WHERE access_token = #{token})
			, #{address}
			, #{areaAddress}
			, #{districtAddress}
			, #{streetAddress}
			, #{estateAddress}
			, #{buildingAddress}
			, #{detailAddress}
			, #{latitude}
			, #{longitude}
			, #{cookingTime}
			, #{menuName}
			, #{menuPrice}
			, #{deliveryPrice}
			, #{totalPrice}
			, #{paid}
			, #{message}
			, #{phone}
			, #{reservationDatetime}
			, #{deviceOs}
			, #{status}
			, #{regOrderId}
			, #{webOrderId}
			, now()
	  	)
		<selectKey keyProperty="id" resultType="String">
			SELECT LAST_INSERT_ID()
		</selectKey>
	</insert>

	<!-- selectOrders -->
	<select id="selectOrders" parameterType="kr.co.cntt.core.model.order.Order" resultMap="selectOrdersResult">
		SELECT
			A.id
			, A.reg_order_id
			, A.created_datetime
            , A.store_id
            , A.rider_id
			, A.address
		    , A.detail_address
			, A.latitude
			, A.longitude
			, A.status
			, A.menu_name
			, A.cooking_time
			, A.paid
			, A.reservation_datetime
			, A.assigned_datetime
			, A.picked_up_datetime
			, A.completed_datetime
            , A.return_datetime
			, A.menu_price
			, A.assigned_first
			, A.combined_order_id
			, A.phone
			, A.message
			, B.id AS rider_id
            , B.name AS rider_name
  			, D.name AS store_name
			, D.latitude AS store_latitude
			, D.longitude AS store_longitude
-- 			, @RNUM := @RNUM + 1 AS RNUM
		FROM TB_ORDER AS A
        LEFT JOIN TB_RIDER AS B
        ON A.rider_id = B.id
        LEFT JOIN TB_SUBGROUP_STORE_REL AS C
        ON A.store_id = C.store_id
		LEFT JOIN TB_STORE AS D
		ON A.store_id = D.id
-- 		, (SELECT @RNUM := 0) E
		WHERE
			<choose>
				<when test="currentDatetime != null and currentDatetime != ''">
					date_add(#{currentDatetime}, interval (#{days} + 1) - 1 day)  > A.created_datetime
					AND A.created_datetime > #{currentDatetime}
				</when>
				<otherwise>
					A.created_datetime > CURRENT_DATE()
				</otherwise>
			</choose>
			<if test="status != null and status != ''">
				AND A.status IN
				<foreach collection="statusArray" item="statusItem" index="index" separator="," open="(" close=")">
					#{statusItem}
				</foreach>
			</if>

			<choose>
				<when test="role != null and role == 'ROLE_STORE'">
					AND A.admin_id = (SELECT admin_id FROM TB_STORE WHERE id = (SELECT store_id FROM TB_STORE_SESSION WHERE access_token = #{token}))
					AND IF((SELECT subgroup_id FROM TB_SUBGROUP_STORE_REL WHERE store_id = (SELECT store_id FROM TB_STORE_SESSION WHERE access_token = #{token}) ORDER BY created_datetime DESC LIMIT 1) IS NOT NULL
						, C.subgroup_id = (SELECT subgroup_id FROM TB_SUBGROUP_STORE_REL WHERE store_id = (SELECT store_id FROM TB_STORE_SESSION WHERE access_token = #{token}) ORDER BY created_datetime DESC LIMIT 1)
						, C.subgroup_id IS NULL AND D.id = (SELECT store_id FROM TB_STORE_SESSION WHERE access_token = #{token}))
					AND C.deleted IS NULL
				</when>
				<when test="role != null and role == 'ROLE_RIDER'">
					AND A.admin_id = (SELECT admin_id FROM TB_RIDER WHERE id = (SELECT rider_id FROM TB_RIDER_SESSION WHERE access_token = #{token}))
					AND IF((SELECT subgroup_id FROM TB_SUBGROUP_RIDER_REL WHERE rider_id = (SELECT rider_id FROM TB_RIDER_SESSION WHERE access_token = #{token}) ORDER BY created_datetime DESC LIMIT 1) IS NOT NULL
						, C.subgroup_id = (SELECT subgroup_id FROM TB_SUBGROUP_RIDER_REL WHERE rider_id = (SELECT rider_id FROM TB_RIDER_SESSION WHERE access_token = #{token}) ORDER BY created_datetime DESC LIMIT 1)
						, C.subgroup_id IS NULL)
					AND C.deleted IS NULL
                </when>
				<otherwise>
					AND A.id IS NULL
				</otherwise>
			</choose>
			AND (A.reservation_datetime IS NULL
			OR (A.created_datetime > CURRENT_DATE() AND DATE_FORMAT(date_add(now(), interval 2 hour), '%Y-%m-%d %H:%i') > DATE_FORMAT(A.reservation_datetime, '%Y-%m-%d %H:%i') AND A.reservation_datetime > CURRENT_DATE()))
-- 			OR (A.created_datetime > CURRENT_DATE() AND date_add(now(), interval 2 hour) > A.reservation_datetime AND A.reservation_datetime > CURRENT_DATE()))
		ORDER BY CASE WHEN A.status in (0,5) THEN A.assigned_first END DESC, CASE WHEN A.status in (0,5) THEN A.reservation_datetime END DESC, A.status in (0,5) desc, A.status ASC,  A.reservation_datetime DESC, A.assigned_first DESC, A.created_datetime DESC
	</select>


	<!-- selectOrderInfo -->
	<select id="selectOrderInfo" parameterType="kr.co.cntt.core.model.common.Common" resultMap="selectOrderInfoResult">
		SELECT
            A.id
			, A.reg_order_id
            , A.created_datetime
			, A.status
			, A.store_id
            , A.rider_id
            , A.address
            , A.detail_address
            , A.latitude
            , A.longitude
			, A.cooking_time
            , A.menu_name
            , A.menu_price
			, A.delivery_price
			, A.total_price
            , A.paid
            , A.message
            , A.phone
            , A.reservation_datetime
            , A.assigned_datetime
            , A.picked_up_datetime
            , A.completed_datetime
            , A.return_datetime
            , A.combined_order_id
            , A.device_os
			, B.id AS rider_id
			, B.name AS rider_name
			, D.name AS store_name
			, D.store_name AS store_real_name
			, D.latitude AS store_latitude
			, D.longitude AS store_longitude
			, D.address AS store_address
			, D.detail_address AS store_detail_address
		FROM TB_ORDER AS A
		LEFT JOIN TB_RIDER AS B
		ON A.rider_id = B.id
		LEFT JOIN TB_SUBGROUP_STORE_REL AS C
		ON A.store_id = C.store_id
		LEFT JOIN TB_STORE AS D
		ON A.store_id = D.id
		WHERE A.reg_order_id = #{id}
			<choose>
				<when test="role != null and role == 'ROLE_STORE'">
					AND A.admin_id = (SELECT admin_id FROM TB_STORE WHERE id = (SELECT store_id FROM TB_STORE_SESSION WHERE access_token = #{token}))
					AND IF((SELECT subgroup_id FROM TB_SUBGROUP_STORE_REL WHERE store_id = (SELECT store_id FROM TB_STORE_SESSION WHERE access_token = #{token}) ORDER BY created_datetime DESC LIMIT 1) IS NOT NULL
						, C.subgroup_id = (SELECT subgroup_id FROM TB_SUBGROUP_STORE_REL WHERE store_id = (SELECT store_id FROM TB_STORE_SESSION WHERE access_token = #{token}) ORDER BY created_datetime DESC LIMIT 1)
						, C.subgroup_id IS NULL AND D.id = (SELECT store_id FROM TB_STORE_SESSION WHERE access_token = #{token}))
					AND C.deleted IS NULL
				</when>
				<when test="role != null and role == 'ROLE_RIDER'">
					AND A.admin_id = (SELECT admin_id FROM TB_RIDER WHERE id = (SELECT rider_id FROM TB_RIDER_SESSION WHERE access_token = #{token}))
					AND IF((SELECT subgroup_id FROM TB_SUBGROUP_RIDER_REL WHERE rider_id = (SELECT rider_id FROM TB_RIDER_SESSION WHERE access_token = #{token}) ORDER BY created_datetime DESC LIMIT 1) IS NOT NULL
						, C.subgroup_id = (SELECT subgroup_id FROM TB_SUBGROUP_RIDER_REL WHERE rider_id = (SELECT rider_id FROM TB_RIDER_SESSION WHERE access_token = #{token}) ORDER BY created_datetime DESC LIMIT 1)
						, C.subgroup_id IS NULL)
					AND C.deleted IS NULL
				</when>
				<otherwise>
					AND A.id IS NULL
				</otherwise>
			</choose>
	</select>


	<!-- updateOrder -->
	<update id="updateOrder" parameterType="kr.co.cntt.core.model.order.Order">
		UPDATE TB_ORDER AS A
		LEFT JOIN TB_RIDER AS B
		ON A.rider_id = B.id
		LEFT JOIN TB_SUBGROUP_STORE_REL AS C
		ON A.store_id = C.store_id
		SET
			A.modified_datetime = now()
			<if test="riderId != null and riderId != '' and riderId != '-1'">
				, A.rider_id = #{riderId}
			</if>
			<if test="riderId == '-1'">
				, A.rider_id = NULL
			</if>
			<if test="address != null and address != ''">
				, A.address = #{address}
			</if>
			<if test="areaAddress != null and areaAddress != ''">
				, A.area_address = #{areaAddress}
			</if>
			<if test="districtAddress != null and districtAddress != ''">
				, A.district_address = #{districtAddress}
			</if>
			<if test="streetAddress != null and streetAddress != ''">
				, A.street_address = #{streetAddress}
			</if>
			<if test="estateAddress != null and estateAddress != ''">
				, A.estate_address = #{estateAddress}
			</if>
			<if test="buildingAddress != null and buildingAddress != ''">
				, A.building_address = #{buildingAddress}
			</if>
			<if test="detailAddress != null and detailAddress != ''">
				, A.detail_address = #{detailAddress}
			</if>
			<if test="latitude != null and latitude != ''">
				, A.latitude = #{latitude}
			</if>
			<if test="longitude != null and longitude != ''">
				, A.longitude = #{longitude}
			</if>
			<if test="status != null and status != ''">
				, A.status = #{status}
			</if>
			<if test="cookingTime != null and cookingTime != ''">
				, cooking_time = #{cookingTime}
			</if>
			<if test="menuName != null and menuName != ''">
				, A.menu_name = #{menuName}
			</if>
			<if test="menuPrice != null and menuPrice != ''">
				, A.menu_price = #{menuPrice}
			</if>
			<if test="deliveryPrice != null and deliveryPrice != ''">
				, A.delivery_price = #{deliveryPrice}
			</if>
			<if test="totalPrice != null and totalPrice != ''">
				, A.total_price = #{totalPrice}
			</if>
			<if test="paid != null and paid != ''">
				, A.paid = #{paid}
			</if>
			<if test="message != null and message != ''">
				, A.message = #{message}
			</if>
			<if test="phone != null and phone != ''">
				, A.phone = #{phone}
			</if>
			<if test="reservationDatetime != null and reservationDatetime != ''">
				, A.reservation_datetime = #{reservationDatetime}
			</if>
			<if test="assignedDatetime != null and assignedDatetime != '' and assignedDatetime != '-1'">
				, A.assigned_datetime = now()
			</if>
			<if test="assignedDatetime == '-1'">
				, A.assigned_datetime = NULL
			</if>
			<if test="pickedUpDatetime != null and pickedUpDatetime != '' and pickedUpDatetime != '-1'">
				, A.picked_up_datetime = #{pickedUpDatetime}
			</if>
			<if test="pickedUpDatetime == '-1'">
				, A.picked_up_datetime = NULL
			</if>
			<if test="completedDatetime != null and completedDatetime != ''">
				, A.completed_datetime = #{completedDatetime}
			</if>
			<if test="combinedOrderId != null and combinedOrderId != ''">
				, A.combined_order_id = #{combinedOrderId}
			</if>
			<if test="deviceOs != null and deviceOs != ''">
				, A.device_os = #{deviceOs}
			</if>
			<if test="role == 'ROLE_STORE' and assignedFirst == 'True'">
				, A.assigned_first = (SELECT * FROM (SELECT IFNULL(MAX(assigned_first), 0) + 1 FROM TB_ORDER) AS D)
			</if>
			<if test="assignXy != null and assignXy != '' and assignXy != 'none'">
				, A.assign_xy = #{assignXy}
			</if>
			<if test="assignXy != null and assignXy != '' and assignXy == 'none'">
				, A.assign_xy = NULL
			</if>
			<if test="pickupXy != null and pickupXy != ''">
				, A.pickup_xy = #{pickupXy}
			</if>
			<if test="completeXy != null and completeXy != ''">
				, A.complete_xy = #{completeXy}
			</if>
			<if test="returnDatetime != null and returnDatetime != ''">
				, A.return_datetime = now()
			</if>
			, A.id = LAST_INSERT_ID(A.id)
		WHERE A.reg_order_id = #{id}
			<choose>
				<when test="role != null and role == 'ROLE_SYSTEM'">
					AND B.deleted IS NULL
					AND C.deleted IS NULL
				</when>
				<when test="role != null and role == 'ROLE_STORE'">
					AND A.admin_id = (SELECT admin_id FROM TB_STORE WHERE id = (SELECT store_id FROM TB_STORE_SESSION WHERE access_token = #{token}))
					AND C.subgroup_id = (SELECT subgroup_id FROM TB_SUBGROUP_STORE_REL WHERE store_id = (SELECT store_id FROM TB_STORE_SESSION WHERE access_token = #{token}) ORDER BY created_datetime DESC LIMIT 1)
					AND B.deleted IS NULL
					AND C.deleted IS NULL
				</when>
				<when test="role != null and role == 'ROLE_RIDER'">
					AND A.admin_id = (SELECT admin_id FROM TB_RIDER WHERE id = (SELECT rider_id FROM TB_RIDER_SESSION WHERE access_token = #{token}))
					AND C.subgroup_id = (SELECT subgroup_id FROM TB_SUBGROUP_RIDER_REL WHERE rider_id = (SELECT rider_id FROM TB_RIDER_SESSION WHERE access_token = #{token}) ORDER BY created_datetime DESC LIMIT 1)
					AND B.deleted IS NULL
					AND C.deleted IS NULL
				</when>
				<otherwise>
					AND A.id IS NULL
				</otherwise>
			</choose>
		<selectKey keyProperty="id" resultType="String">
			SELECT LAST_INSERT_ID()
		</selectKey>
	</update>


	<!-- selectOrderIsApprovalCompleted -->
	<select id="selectOrderIsApprovalCompleted" parameterType="kr.co.cntt.core.model.order.Order" resultType="int">
		SELECT
			COUNT(*)
		FROM TB_ORDER AS A INNER JOIN TB_PAYMENT AS B
		ON A.id = B.order_id
		WHERE A.id = (SELECT id FROM TB_ORDER WHERE reg_order_id=#{id})
			AND B.status = 0
	</select>


	<!-- selectOrderIsCompletedIsCanceled -->
	<select id="selectOrderIsCompletedIsCanceled" parameterType="kr.co.cntt.core.model.order.Order" resultType="int">
		SELECT
			COUNT(*)
		FROM TB_ORDER
		WHERE id = (SELECT id FROM TB_ORDER WHERE reg_order_id=#{id})
			AND (status = 3 OR status = 4)
	</select>

	<!-- RegOrderIDCheckt reg 오더 중복 체크  -->
	<select id="selectRegOrderIdCheck" parameterType="kr.co.cntt.core.model.order.Order" resultType="int">
		SELECT
		COUNT(*)
		FROM TB_ORDER
		WHERE reg_order_id = #{regOrderId}
	</select>




	<!-- insertOrderConfirm -->
    <insert id="insertOrderConfirm" parameterType="kr.co.cntt.core.model.order.Order">
        INSERT INTO TB_ORDER_CONFIRM_ASSIGNMENT (
          created_datetime
          , confirmed_datetime
          , admin_id
          , store_id
          , rider_id
          , order_id
        ) VALUES (
          now()
          , now()
          , (SELECT admin_id FROM TB_RIDER WHERE id = (SELECT rider_id FROM TB_RIDER_SESSION WHERE access_token = #{token}))
          , (
              SELECT store_id
              FROM TB_SUBGROUP_RIDER_REL
              WHERE rider_id = (SELECT rider_id FROM TB_RIDER_SESSION WHERE access_token = #{token})
                  AND admin_id = (SELECT admin_id FROM TB_RIDER WHERE id = (SELECT rider_id FROM TB_RIDER_SESSION WHERE access_token = #{token}))
              ORDER BY created_datetime DESC LIMIT 1
            )
          , (SELECT rider_id FROM TB_RIDER_SESSION WHERE access_token = #{token})
          , #{id}
        )
    </insert>


    <!-- insertOrderDeny -->
    <insert id="insertOrderDeny" parameterType="kr.co.cntt.core.model.order.Order">
        INSERT INTO TB_ORDER_DENY_ASSIGNMENT (
          created_datetime
          , denied_datetime
          , admin_id
          , store_id
          , rider_id
          , order_id
          , status
          , reason
        ) VALUES (
          now()
          , now()
          , (SELECT admin_id FROM TB_RIDER WHERE id = (SELECT rider_id FROM TB_RIDER_SESSION WHERE access_token = #{token}))
          , (
              SELECT store_id
              FROM TB_SUBGROUP_RIDER_REL
              WHERE rider_id = (SELECT rider_id FROM TB_RIDER_SESSION WHERE access_token = #{token})
                  AND admin_id = (SELECT admin_id FROM TB_RIDER WHERE id = (SELECT rider_id FROM TB_RIDER_SESSION WHERE access_token = #{token}))
              ORDER BY created_datetime DESC LIMIT 1
            )
          , (SELECT rider_id FROM TB_RIDER_SESSION WHERE access_token = #{token})
          , #{id}
          , #{orderCheckAssignment.status}
          , #{orderCheckAssignment.reason}
        )
    </insert>


    <!-- selectOrderConfirm -->
    <select id="selectOrderConfirm" parameterType="kr.co.cntt.core.model.order.Order" resultType="kr.co.cntt.core.model.order.OrderCheckAssignment">
        SELECT
          order_id
          , rider_id
          , confirmed_datetime
        FROM TB_ORDER_CONFIRM_ASSIGNMENT
        WHERE order_id = #{id}
    </select>


    <!-- selectOrderDeny -->
    <select id="selectOrderDeny" parameterType="kr.co.cntt.core.model.order.Order" resultType="kr.co.cntt.core.model.order.OrderCheckAssignment">
        SELECT
          order_id
          , rider_id
          , denied_datetime
        FROM TB_ORDER_DENY_ASSIGNMENT
        WHERE order_id = #{id}
    </select>


    <!-- selectOrderDenyCount -->
    <select id="selectOrderDenyCount" parameterType="kr.co.cntt.core.model.rider.Rider" resultType="int">
        SELECT COUNT(A.status)
        FROM TB_ORDER_DENY_ASSIGNMENT AS A
        LEFT JOIN TB_RIDER AS B
        ON A.rider_id = B.id
        WHERE A.rider_id = (SELECT rider_id FROM TB_RIDER_SESSION WHERE access_token = #{token})
        	AND A.status = 1
        	AND A.denied_datetime > B.last_access
        	AND A.denied_datetime > CURRENT_DATE()
    </select>

	<!-- selectFooterOrders -->
	<select id="selectFooterOrders" parameterType="kr.co.cntt.core.model.order.Order" resultMap="selectOrdersResult">
		SELECT
		A.status, count(*)as count
		FROM TB_ORDER AS A
		LEFT JOIN TB_RIDER AS B
		ON A.rider_id = B.id
		LEFT JOIN TB_SUBGROUP_STORE_REL AS C
		ON A.store_id = C.store_id
		LEFT JOIN TB_STORE AS D
		ON A.store_id = D.id
		WHERE	A.created_datetime > current_date()
		AND A.status IN (0,1,2,3,4,5)
		AND A.admin_id = (SELECT admin_id FROM TB_STORE WHERE id = (SELECT store_id FROM TB_STORE_SESSION WHERE access_token = #{token}))
		AND C.subgroup_id = (SELECT subgroup_id FROM TB_SUBGROUP_STORE_REL WHERE store_id = (SELECT store_id FROM TB_STORE_SESSION WHERE access_token = #{token}) ORDER BY created_datetime DESC LIMIT 1)
		AND C.deleted IS NULL group by A.status;
	</select>

	<!-- selectForAssignOrders -->
	<select id="selectForAssignOrders" resultMap="selectOrdersResult">
		SELECT A.id
			, A.reg_order_id
		    , A.created_datetime
		    , A.reservation_datetime
		    , A.latitude
		    , A.longitude
		    , A.store_id
		    , B.id AS store_id
		    , B.latitude AS store_latitude
		    , B.longitude AS store_longitude
		    , B.radius
		    , B.assignment_limit
		    , B.store_distance_sort
		    , B.admin_id
		    , B.store_name
		    , A.address
		FROM TB_ORDER AS A
        LEFT JOIN TB_STORE AS B
        ON A.store_id = B.id
        LEFT JOIN TB_SUBGROUP_STORE_REL AS C
        ON B.id = C.store_id
        WHERE B.deleted IS NULL
            AND C.deleted IS NULL
            AND B.assignment_status=1
            AND (A.status = 0 OR A.status =5)
            AND A.created_datetime > CURRENT_DATE()
   			AND (A.reservation_datetime IS NULL
			OR (date_add(now(), interval 2 hour) > A.reservation_datetime))
--             AND C.subgroup_id IS NOT NULL
		ORDER BY A.reservation_datetime DESC, A.assigned_first DESC, A.created_datetime ASC
	</select>


	<select id="selectOrderLocation" parameterType="String" resultType="kr.co.cntt.core.model.order.Order">
		SELECT
		id
		, latitude
		, longitude
		FROM TB_ORDER
		WHERE id = #{id}
	</select>


	<!-- selectOrderFirstAssignmentReason -->
	<select id="selectOrderFirstAssignmentReason" parameterType="kr.co.cntt.core.model.common.Common" resultType="kr.co.cntt.core.model.reason.Reason">
		SELECT id
		, reason
		, admin_id
		FROM TB_ORDER_FIRST_ASSIGNMENT_REASON
		WHERE deleted IS NULL
		<choose>
			<when test="role != null and role == 'ROLE_STORE'">
				AND admin_id = (SELECT admin_id FROM TB_STORE WHERE id = (SELECT store_id FROM TB_STORE_SESSION WHERE access_token = #{token}))
			</when>
			<when test="role != null and role == 'ROLE_RIDER'">
				AND admin_id = (SELECT admin_id FROM TB_RIDER WHERE id = (SELECT rider_id FROM TB_RIDER_SESSION WHERE access_token = #{token}))
			</when>
			<when test="role != null and role == 'ROLE_ADMIN'">
				AND admin_id = (SELECT admin_id FROM TB_ADMIN_SESSION WHERE access_token = #{token})
			</when>
			<otherwise>
				AND id IS NULL
			</otherwise>
		</choose>
	</select>


	<select id="selectPushToken" parameterType="kr.co.cntt.core.model.store.Store" resultType="String">
		select TBRS.push_token
		from TB_RIDER_SESSION AS TBRS
		   left join TB_SUBGROUP_RIDER_REL AS TSRR
		       on TSRR.subgroup_id = #{groupId}
		and TBRS.rider_id = TSRR.rider_id
		where TBRS.push_token is not null and TBRS.expiry_datetime is null
	</select>


	<select id="selectReservationOrders" resultMap="selectReservationOrdersResult">
		SELECT A.id
			, A.created_datetime
			, A.reservation_datetime
			, A.admin_id
			, A.store_id
			, A.rider_id
			, (SELECT subgroup_id FROM TB_SUBGROUP_STORE_REL WHERE store_id = A.store_id ORDER BY created_datetime DESC LIMIT 1) AS subgroup_id
		FROM TB_ORDER AS A
		LEFT JOIN TB_SUBGROUP_STORE_REL AS B
		ON A.store_id = B.store_id
		WHERE (A.status = 0 OR A.status =5)
			AND A.created_datetime > CURRENT_DATE()
			AND DATE_FORMAT(date_add(now(), interval 2 hour), '%Y-%m-%d %H:%i') = DATE_FORMAT(A.reservation_datetime, '%Y-%m-%d %H:%i')
-- 			AND date_add(now(), interval 2 hour) = A.reservation_datetime
		ORDER BY A.reservation_datetime DESC, A.assigned_first DESC, A.created_datetime ASC
	</select>
</mapper>
 