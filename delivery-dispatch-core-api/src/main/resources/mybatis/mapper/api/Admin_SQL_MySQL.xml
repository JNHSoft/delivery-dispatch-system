<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="kr.co.cntt.core.mapper.AdminMapper">

	<select id="selectLoginAdmin" parameterType="kr.co.cntt.core.model.admin.Admin" resultType="String">
		SELECT login_id, id FROM TB_ADMIN
		WHERE 1=1
		AND login_id = #{loginId}
		<!--AND login_pw = #{loginPw}-->
		limit 1
	</select>


	<!--
		- login ID  및 Aceess 토근 값체크
		- expiry_datetime 이 NULL 이거나 금일 datetime 보다 큰 값
	-->
	<select id="selectAdminTokenCheck" parameterType="kr.co.cntt.core.model.admin.Admin" resultType="int">
		<![CDATA[
		SELECT
			COUNT(*)
		FROM TB_ADMIN A JOIN TB_ADMIN_SESSION B
		ON A.id = B.admin_id
		WHERE 1=1
			AND A.login_id = #{loginId}
			AND B.access_token = #{accessToken}
			AND (expiry_datetime IS NULL OR expiry_datetime > now())
		]]>
	</select>


	<!-- insertAdminSession -->
	<insert id="insertAdminSession" parameterType="kr.co.cntt.core.model.admin.Admin">
		<![CDATA[
		INSERT INTO TB_ADMIN_SESSION(admin_id, access_token, created_datetime)
		SELECT
			id,
			#{accessToken},
			now()
		FROM TB_ADMIN
		WHERE login_id = #{loginId}
		]]>
	</insert>


	<!-- selectAdminInfo -->
	<select id="selectAdminInfo" parameterType="kr.co.cntt.core.model.admin.Admin" resultType="kr.co.cntt.core.model.admin.Admin">
		SELECT
			created_datetime,
			modified_datetime,
			chat_user_id,
			id,
			name,
			login_id,
			login_pw,
			state
		FROM TB_ADMIN
		WHERE id = (SELECT admin_id FROM TB_ADMIN_SESSION WHERE access_token = #{accessToken})
	</select>


	<!-- insertChatUser -->
	<insert id="insertChatUser" parameterType="kr.co.cntt.core.model.login.User">
		INSERT INTO TB_CHAT_USER (
			created_datetime,
			type
		) VALUES (
			now(),
			3
		)
		<selectKey keyProperty="chatUserId" resultType="String">
			SELECT LAST_INSERT_ID()
		</selectKey>
	</insert>


	<!-- insertChatRoom -->
	<insert id="insertChatRoom" parameterType="kr.co.cntt.core.model.login.User">
		INSERT INTO TB_CHATROOM (
			created_datetime
		) VALUES (
			now()
		)
		<selectKey keyProperty="chatRoomId" resultType="String">
			SELECT LAST_INSERT_ID()
		</selectKey>
	</insert>


	<!-- insertChatUserChatRoomRel -->
	<insert id="insertChatUserChatRoomRel" parameterType="kr.co.cntt.core.model.login.User">
		INSERT INTO TB_CHAT_USER_CHATROOM_REL (
			chat_user_id,
			chatroom_id
		) VALUES (
			#{chatUserId},
			#{chatRoomId}
		)
	</insert>


	<!-- selectRiders -->
	<select id="selectRiders" parameterType="kr.co.cntt.core.model.admin.Admin" resultType="kr.co.cntt.core.model.rider.Rider">
		SELECT
			id,
			name,
			phone,
			login_id,
			position,
			gender,
			employment_type,
			working,
			status
		FROM TB_RIDER
		WHERE admin_id = (SELECT admin_id FROM TB_ADMIN_SESSION WHERE access_token = #{accessToken})
	</select>


	<!-- insertRider -->
	<insert id="insertRider" parameterType="kr.co.cntt.core.model.rider.Rider">
		INSERT INTO TB_RIDER (
			created_datetime,
			chat_user_id,
			admin_id,
			name,
			phone,
			login_id,
			login_pw,
			position,
			gender,
			employment_type,
			address,
			vehicle_number,
			emergency_phone,
			comment
		) VALUES (
			now(),
			#{chatUserId},
			(SELECT admin_id FROM TB_ADMIN_SESSION WHERE access_token = #{token}),
			#{name},
			#{phone},
			#{loginId},
			#{loginPw},
			#{position},
			<if test="gender != null and gender != ''">
				#{gender},
			</if>
			<if test="gender == null || gender == ''">
				0,
			</if>
			<if test="employmentType != null and employmentType != ''">
				#{employmentType},
			</if>
			<if test="employmentType == null || employmentType == ''">
				0,
			</if>
			<if test="address != address and address != ''">
				#{address},
			</if>
			<if test="address == null || address == ''">
				NULL,
			</if>
			<if test="vehicleNumber != null and vehicleNumber != ''">
				#{vehicleNumber},
			</if>
			<if test="vehicleNumber == null || vehicleNumber == ''">
				NULL,
			</if>
			<if test="emergencyPhone != null and emergencyPhone != ''">
				#{emergencyPhone},
			</if>
			<if test="emergencyPhone == null || emergencyPhone == ''">
				NULL,
			</if>
			<if test="comment != null and comment != ''">
				#{comment},
			</if>
			<if test="comment == null || comment == ''">
				NULL
			</if>
		)
	</insert>


	<!-- selectStores -->
	<select id="selectStores" parameterType="kr.co.cntt.core.model.admin.Admin" resultType="kr.co.cntt.core.model.store.Store">
		SELECT
			id,
			code,
			name,
			phone,
			store_name,
			ch_store_name,
			store_phone,
			login_id,
			store_status,
			assignment_status
		FROM TB_STORE
		WHERE admin_id = (SELECT admin_id FROM TB_ADMIN_SESSION WHERE access_token = #{accessToken})
	</select>

</mapper>
 