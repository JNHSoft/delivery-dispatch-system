<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="kr.co.cntt.core.mapper.NoticeMapper">

    <!-- insert Notice 공지사항 등록  -->
    <insert id="insertNotice" parameterType="kr.co.cntt.core.model.notice.Notice">
        INSERT INTO TB_NOTICE (
            created_datetime
            , admin_id
            , title
            , content
            , to_group_id
            , to_subgroup_id
            , to_store_id
            , ori_file_name
            , file_name
            , file_size
        ) VALUES(
              now()
            , #{adminId}
            , #{title}
            , #{content}
        <if test="toGroupId != null and toGroupId != ''">
            , #{toGroupId}
        </if>

        <if test="toGroupId == null or toGroupId == ''">
            , 0
        </if>

        <if test="toSubGroupId != null and toSubGroupId != ''">
            , #{toSubGroupId}
        </if>

        <if test="toSubGroupId == null or toSubGroupId == ''">
            , 0
        </if>

        <if test="toStoreId != null and toStoreId != ''">
            , #{toStoreId}
        </if>

        <if test="toStoreId == null or toStoreId == ''">
            , 0
        </if>

        <if test="oriFileName != null and oriFileName != ''">
          , #{oriFileName}
        </if>

        <if test="oriFileName == null or oriFileName == ''">
          , null
        </if>

        <if test="fileName != null and fileName != ''">
          , #{fileName}
        </if>

        <if test="fileName == null or fileName == ''">
          , null
        </if>

        <if test="fileSize != null and fileSize != ''">
          , #{fileSize}
        </if>

        <if test="fileSize == null or fileSize == ''">
          , null
        </if>

        )
    </insert>

    <!--AdminID 관리자가 공지사항 작성 -->
    <select id="selectAdminId" parameterType="kr.co.cntt.core.model.notice.Notice"  resultType="kr.co.cntt.core.model.notice.Notice">
        SELECT
          admin_id
        FROM
          TB_ADMIN_SESSION
        WHERE
          access_token=#{token}
    </select>

    <!--StoreID 상점 공지사항 작성 -->
    <select id="selectStoreAdminId" parameterType="kr.co.cntt.core.model.notice.Notice"  resultType="kr.co.cntt.core.model.notice.Notice">
        SELECT
          st.admin_id
        , se.store_id      AS writer_id
        FROM
          TB_STORE_SESSION AS se
        INNER JOIN
          TB_STORE         AS st
        ON se.store_id = st.id

        WHERE
        access_token = #{token}

    </select>

    <!--공지사항 수정-->
    <update id="updateNotice" parameterType="kr.co.cntt.core.model.notice.Notice">
      UPDATE TB_NOTICE
      SET
        modified_datetime = now()
        , admin_id = #{adminId}
        , writer_id = #{writerId}

      <if test="title != null and title != ''">
        , title = #{title}
      </if>

      <if test="title != null and title != ''">
        , content = #{content}
      </if>

      WHERE 1=1
      AND id = #{id}
      AND admin_id = (select admin_id from TB_ADMIN_SESSION where access_token=#{token})


    </update>

    <!--공지사항 삭제-->
    <update id="deleteNotice" parameterType="kr.co.cntt.core.model.notice.Notice">
        UPDATE TB_NOTICE
        SET
          deleted = now()
        WHERE
          id = #{id}
        AND
          admin_id = #{adminId}
        <if test="writerType == '2'">
            AND writer_id = #{writerId}
        </if>
    </update>

    <!--공지사항 상세 보기  admin store -->
    <select id="getAdminStoreDetailNoticeList" parameterType="kr.co.cntt.core.model.notice.Notice" resultType="kr.co.cntt.core.model.notice.Notice">
        SELECT
            created_datetime
            , modified_datetime
            , id
            , admin_id
            , writer_id
            , writer_type
            , title
            , content
            , (SELECT name FROM TB_ADMIN WHERE id=#{writerId}) AS writerName
            , to_rider
            , to_store

        FROM
          TB_NOTICE
        WHERE
          id = #{id}
          AND deleted IS NUll
          AND writer_id = #{writerId}
          AND writer_type = #{writerType}
          AND to_store = 1
    </select>


    <!--공지사항 상세 보기 store -->
    <select id="getStoreDetailNoticeList" parameterType="kr.co.cntt.core.model.notice.Notice" resultType="kr.co.cntt.core.model.notice.Notice">
        SELECT
        created_datetime
        , modified_datetime
        , id
        , admin_id
        , writer_id
        , writer_type
        , title
        , content
        , (SELECT store_name FROM TB_STORE WHERE id=#{writerId}) AS writerName
        , to_rider
        , to_store

        FROM
        TB_NOTICE
        WHERE
        id = #{id}
        AND deleted IS NUll
        AND writer_id = #{writerId}
        AND writer_type = #{writerType}
        AND to_store = 1
    </select>

    <!--공지사항 상세보기 rider Admin-->
    <select id="getRiderAdminDetailNoticeList" parameterType="kr.co.cntt.core.model.notice.Notice" resultType="kr.co.cntt.core.model.notice.Notice">
        SELECT
            created_datetime
            , modified_datetime
            , id
            , admin_id
            , writer_id
            , writer_type
            , title
            , content
            , (SELECT name FROM TB_ADMIN WHERE id=#{writerId}) AS writerName
            , to_rider
            , to_store

        FROM
          TB_NOTICE
        WHERE
          id = #{id}
        AND deleted IS NUll
        AND writer_id = #{writerId}
        AND writer_type = #{writerType}
        AND to_rider = 1
    </select>

    <!--공지사항 상세 보기 rider -->
    <select id="getRiderStoreDetailNoticeList" parameterType="kr.co.cntt.core.model.notice.Notice" resultType="kr.co.cntt.core.model.notice.Notice">
        SELECT
        created_datetime
        , modified_datetime
        , id
        , admin_id
        , writer_id
        , writer_type
        , title
        , content
        , (SELECT store_name FROM TB_STORE WHERE id=#{writerId}) AS writerName
        , to_rider
        , to_store

        FROM
        TB_NOTICE
        WHERE
        id = #{id}
        AND deleted IS NUll
        AND writer_id = #{writerId}
        AND writer_type = #{writerType}
        AND to_rider = 1
    </select>


    <!--공지사항 상세 보기 ADMIN admin-->
    <select id="getAdminDetailNoticeList" parameterType="kr.co.cntt.core.model.notice.Notice" resultType="kr.co.cntt.core.model.notice.Notice">
        SELECT
        created_datetime
        , modified_datetime
        , id
        , admin_id
        , writer_id
        , writer_type
        , title
        , content
        , (SELECT name FROM TB_ADMIN WHERE id=#{writerId}) AS writerName
        , to_rider
        , to_store

        FROM
        TB_NOTICE
        WHERE
        id = #{id}
        AND deleted IS NUll
        AND writer_id = #{writerId}
        AND writer_type = #{writerType}

    </select>


    <!--공지사항 상세 보기 ADMIN store-->
    <select id="getStoreAdminDetailNoticeList" parameterType="kr.co.cntt.core.model.notice.Notice" resultType="kr.co.cntt.core.model.notice.Notice">
        SELECT
        created_datetime
        , modified_datetime
        , id
        , admin_id
        , writer_id
        , writer_type
        , title
        , content
        , (SELECT store_name FROM TB_STORE WHERE id=#{writerId}) AS writerName
        , to_rider
        , to_store

        FROM
        TB_NOTICE
        WHERE
        id = #{id}
        AND deleted IS NUll
        AND writer_id = #{writerId}
        AND writer_type = #{writerType}

    </select>



    <!--라이더 공지사항 보기 Admin-->
    <select id="getRiderAdminNoticeList" parameterType="kr.co.cntt.core.model.notice.Notice" resultType="kr.co.cntt.core.model.notice.Notice">
        SELECT
            created_datetime
            , modified_datetime
            , id
            , admin_id
            , writer_id
            , writer_type
            , title
            , to_rider
            , to_store
        FROM
          TB_NOTICE
        WHERE
          admin_id =(
          SELECT
            admin_id
          FROM
            TB_RIDER
          WHERE
            id =(
              SELECT
                rider_id
              FROM
                TB_RIDER_SESSION
              WHERE
                access_token = #{token}))
        AND deleted IS NUll
        AND writer_type = 1
        AND to_rider = 1
    </select>


    <!-- 라이더 공지사항 보기 Store -->
    <select id="getRiderStoreNoticeList" parameterType="kr.co.cntt.core.model.notice.Notice" resultType="kr.co.cntt.core.model.notice.Notice">
        SELECT
            created_datetime
            , modified_datetime
            , id
            , admin_id
            , writer_id
            , writer_type
            , title
            , to_rider
            , to_store
        FROM
          TB_NOTICE
        WHERE
          admin_id =(
            SELECT
              admin_id
            FROM
              TB_RIDER
            WHERE
              id =(
                SELECT
                  rider_id
                FROM
                  TB_RIDER_SESSION
                WHERE
                  access_token = #{token}))
        AND deleted IS NUll
        AND writer_type = 2
        AND to_rider = 1
    </select>

    <!--store 공지 보기 admin-->
    <select id="getStoreAdminNoticeList" parameterType="kr.co.cntt.core.model.notice.Notice" resultType="kr.co.cntt.core.model.notice.Notice">
        SELECT
            created_datetime
            , modified_datetime
            , id
            , admin_id
            , writer_id
            , writer_type
            , title
            , to_rider
            , to_store
        FROM
          TB_NOTICE
        WHERE
          admin_id =(
            SELECT
              admin_id
            FROM
              TB_STORE
            WHERE
              id =(
                SELECT
                  store_id
                FROM
                  TB_STORE_SESSION
                WHERE
                  access_token = #{token}))
        AND deleted IS NUll
        AND writer_type = 1
        AND to_store = 1
    </select>


    <!--store 공지 보기 store-->
    <select id="getStoreNoticeList" parameterType="kr.co.cntt.core.model.notice.Notice" resultType="kr.co.cntt.core.model.notice.Notice">
        SELECT
            created_datetime
            , modified_datetime
            , id
            , admin_id
            , writer_id
            , writer_type
            , title
            , to_rider
            , to_store
        FROM
          TB_NOTICE
        WHERE
          admin_id =(
            SELECT
              admin_id
            FROM
              TB_STORE
            WHERE
              id =(
                SELECT
                  store_id
                FROM
                  TB_STORE_SESSION
                WHERE
                  access_token = #{token}))
        AND deleted IS NUll
        AND writer_type = 2
        AND to_store = 1
    </select>


    <!--admin 공지 보기 -->
    <select id="getAdminNoticeList" parameterType="kr.co.cntt.core.model.notice.Notice" resultType="kr.co.cntt.core.model.notice.Notice">
        SELECT
            created_datetime
            , modified_datetime
            , id
            , admin_id
            , writer_id
            , writer_type
            , title
            , to_rider
            , to_store
        FROM
          TB_NOTICE
        WHERE
          admin_id =(
            SELECT
              id
            FROM
              TB_ADMIN
          WHERE
            id =(
              SELECT
                admin_id
              FROM
                TB_ADMIN_SESSION
              WHERE
                access_token = #{token}))
          AND deleted IS NUll
    </select>

</mapper>