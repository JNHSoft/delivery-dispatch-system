<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="kr.co.cntt.core.mapper.NoticeMapper">

    <!-- insert Notice 공지사항 등록  -->
    <insert id="insertNotice" parameterType="kr.co.cntt.core.model.notice.Notice">
        INSERT INTO TB_NOTICE (
            created_datetime
            , admin_id
            , title
            , content
            , to_group_id
            , to_subgroup_id
            , to_store_id
            , ori_file_name
            , file_name
            , file_size
        ) VALUES(
              now()
            , #{adminId}
            , #{title}
            , #{content}

        <if test="toGroupId != null and toGroupId != ''">
            , #{toGroupId}
        </if>

        <if test="toGroupId == null or toGroupId == ''">
            , 0
        </if>

        <if test="toSubGroupId != null and toSubGroupId != ''">
            , #{toSubGroupId}
        </if>

        <if test="toSubGroupId == null or toSubGroupId == ''">
            , 0
        </if>

        <if test="toStoreId != null and toStoreId != ''">
            , #{toStoreId}
        </if>

        <if test="toStoreId == null or toStoreId == ''">
            , 0
        </if>

        <if test="oriFileName != null and oriFileName != ''">
          , #{oriFileName}
        </if>

        <if test="oriFileName == null or oriFileName == ''">
          , null
        </if>

        <if test="fileName != null and fileName != ''">
          , #{fileName}
        </if>

        <if test="fileName == null or fileName == ''">
          , null
        </if>

        <if test="fileSize != null and fileSize != ''">
          , #{fileSize}
        </if>

        <if test="fileSize == null or fileSize == ''">
          , null
        </if>

        )
    </insert>

    <!--AdminID 관리자가 공지사항 작성 -->
    <select id="selectAdminId" parameterType="kr.co.cntt.core.model.notice.Notice"  resultType="kr.co.cntt.core.model.notice.Notice">
        SELECT
          admin_id
        FROM
          TB_ADMIN_SESSION
        WHERE
          access_token=#{token}
    </select>

    <!--&lt;!&ndash;StoreID 상점 공지사항 작성 &ndash;&gt;-->
    <!--<select id="selectStoreAdminId" parameterType="kr.co.cntt.core.model.notice.Notice"  resultType="kr.co.cntt.core.model.notice.Notice">-->
        <!--SELECT-->
          <!--st.admin_id-->
        <!--, se.store_id      AS writer_id-->
        <!--FROM-->
          <!--TB_STORE_SESSION AS se-->
        <!--INNER JOIN-->
          <!--TB_STORE         AS st-->
        <!--ON se.store_id = st.id-->

        <!--WHERE-->
        <!--access_token = #{token}-->

    <!--</select>-->

    <!--공지사항 수정-->
    <update id="updateNotice" parameterType="kr.co.cntt.core.model.notice.Notice">
      UPDATE TB_NOTICE
      SET
        modified_datetime = now()
        , admin_id = #{adminId}

      <if test="title != null and title != ''">
        , title = #{title}
      </if>

      <if test="title != null and title != ''">
        , content = #{content}
      </if>


      <if test="toGroupId != null and toGroupId != ''">
        , to_group_id = #{toGroupId}
      </if>

      <if test="toGroupId == null or toGroupId == ''">
        , to_group_id = 0
      </if>

      <if test="toSubGroupId != null and toSubGroupId != ''">
        , to_subgroup_id = #{toSubGroupId}
      </if>

      <if test="toSubGroupId == null or toSubGroupId == ''">
        , to_subgroup_id = 0
      </if>

      <if test="toStoreId != null and toStoreId != ''">
        , to_store_id = #{toStoreId}
      </if>

      <if test="toStoreId == null or toStoreId == ''">
        , to_store_id = 0
      </if>

      <if test="oriFileName != null and oriFileName != ''">
        , ori_file_name = #{oriFileName}
      </if>


      <if test="fileName != null and fileName != ''">
        , file_name = #{fileName}
      </if>



      <if test="fileSize != null and fileSize != ''">
        , file_size = #{fileSize}
      </if>

      WHERE 1=1
      AND id = #{id}
      AND admin_id = (select admin_id from TB_ADMIN_SESSION where access_token=#{token})


    </update>

    <!--공지사항 삭제-->
    <update id="deleteNotice" parameterType="kr.co.cntt.core.model.notice.Notice">
        UPDATE TB_NOTICE
        SET
          deleted = now()
        WHERE
          id = #{id}
        AND
          admin_id = (select admin_id from TB_ADMIN_SESSION where access_token=#{token})

    </update>



    <!--공지사항 상세 보기 store -->
    <select id="getStoreDetailNoticeList" parameterType="kr.co.cntt.core.model.notice.Notice" resultType="kr.co.cntt.core.model.notice.Notice">
        SELECT
            A.created_datetime
            , A.modified_datetime
            , A.id
            , A.admin_id
            , A.title
            , A.content
            , A.to_group_id
            , A.to_subgroup_id
            , A.to_store_id
            , A.ori_file_name
            , A.file_name
            , A.file_size
            , B.confirmed_datetime
        FROM TB_NOTICE AS A
        LEFT JOIN TB_NOTICE_CONFIRM AS B
        ON A.id = B.notice_id
        WHERE A.id = #{id}
            AND A.deleted IS NUll
            AND A.admin_id = (SELECT admin_id FROM TB_STORE WHERE id =(select store_id from TB_STORE_SESSION where access_token=#{token}))
    </select>


    <!--공지사항 상세 보기 rider -->
    <select id="getRiderDetailNoticeList" parameterType="kr.co.cntt.core.model.notice.Notice" resultType="kr.co.cntt.core.model.notice.Notice">
        SELECT
        created_datetime
        , modified_datetime
        , id
        , admin_id
        , title
        , content
        , to_group_id
        , to_subgroup_id
        , to_store_id
        , ori_file_name
        , file_name
        , file_size

        FROM
        TB_NOTICE
        WHERE
        id = #{id}
        AND deleted IS NUll
        AND admin_id = (SELECT admin_id FROM TB_RIDER WHERE id = (select rider_id from TB_RIDER_SESSION where access_token=#{token}))
    </select>


    <!--공지사항 상세 보기 ADMIN -->
    <select id="getAdminDetailNoticeList" parameterType="kr.co.cntt.core.model.notice.Notice" resultType="kr.co.cntt.core.model.notice.Notice">
        SELECT
        created_datetime
        , modified_datetime
        , id
        , admin_id
        , title
        , content
        , to_group_id
        , to_subgroup_id
        , to_store_id
        , ori_file_name
        , file_name
        , file_size

        FROM
        TB_NOTICE
        WHERE
        id = #{id}
        AND deleted IS NUll
        AND admin_id = (select admin_id from TB_ADMIN_SESSION where access_token=#{token})
    </select>


    <!--라이더 공지사항 list-->
    <select id="getRiderNoticeList" parameterType="kr.co.cntt.core.model.notice.Notice" resultType="kr.co.cntt.core.model.notice.Notice">
        SELECT
            created_datetime
            , modified_datetime
            , id
            , admin_id
            , title
            , to_group_id
            , to_subgroup_id
            , to_store_id
            , ori_file_name
            , file_name
            , file_size

        FROM
          TB_NOTICE
        WHERE 1=1
        AND admin_id = (SELECT admin_id FROM TB_RIDER WHERE id = (select rider_id from TB_RIDER_SESSION where access_token=#{token}))
        AND deleted IS NUll
    </select>


    <!--store 공지사항 list-->
    <select id="getStoreNoticeList" parameterType="kr.co.cntt.core.model.notice.Notice" resultType="kr.co.cntt.core.model.notice.Notice">
        SELECT
            created_datetime
            , modified_datetime
            , id
            , admin_id
            , title
            , to_group_id
            , to_subgroup_id
            , to_store_id
            , ori_file_name
            , file_name
            , file_size
        FROM
          TB_NOTICE
        WHERE 1=1
        AND admin_id = (SELECT admin_id FROM TB_STORE WHERE id =(select store_id from TB_STORE_SESSION where access_token=#{token}))
        AND deleted IS NUll
    </select>


    <!--admin 공지사항 list -->
    <select id="getAdminNoticeList" parameterType="kr.co.cntt.core.model.notice.Notice" resultType="kr.co.cntt.core.model.notice.Notice">
        SELECT
              created_datetime
            , modified_datetime
            , id
            , admin_id
            , title
            , to_group_id
            , to_subgroup_id
            , to_store_id
            , ori_file_name
            , file_name
            , file_size
        FROM
          TB_NOTICE
        WHERE 1=1
        AND admin_id = (select admin_id from TB_ADMIN_SESSION where access_token=#{token})
        AND deleted IS NUll
    </select>

    <select id="selectAllToken" resultType="String">
        select TBRS.push_token
        from dde.TB_RIDER_SESSION AS TBRS
        where TBRS.push_token is not null
    </select>


    <!-- selectNoticeConfirm -->
    <select id="selectNoticeConfirm" parameterType="kr.co.cntt.core.model.notice.Notice" resultType="kr.co.cntt.core.model.notice.Notice">
        SELECT
            created_datetime
            , modified_datetime
            , id
            , admin_id
            , store_id
            , notice_id
        FROM TB_NOTICE_CONFIRM
        WHERE deleted IS NULL
            AND notice_id = #{id}
            AND admin_id = (SELECT admin_id FROM TB_STORE WHERE id =(SELECT store_id FROM TB_STORE_SESSION WHERE access_token=#{token}))
            AND store_id = (SELECT store_id FROM TB_STORE_SESSION WHERE access_token=#{token})
    </select>


    <!-- insertNoticeConfirm -->
    <insert id="insertNoticeConfirm" parameterType="kr.co.cntt.core.model.notice.Notice">
        INSERT INTO TB_NOTICE_CONFIRM (
            created_datetime
            , admin_id
            , store_id
            , notice_id
            , confirmed_datetime
        ) VALUES (
            now()
            , (SELECT admin_id FROM TB_STORE WHERE id =(SELECT store_id FROM TB_STORE_SESSION WHERE access_token=#{token}))
            , (SELECT store_id FROM TB_STORE_SESSION WHERE access_token=#{token})
            , #{id}
            , now()
        )
    </insert>


    <!-- updateNoticeConfirm -->
    <update id="updateNoticeConfirm" parameterType="kr.co.cntt.core.model.notice.Notice">
        UPDATE TB_NOTICE_CONFIRM
        SET modified_datetime = now()
            , confirmed_datetime = now()
        WHERE deleted IS NULL
            AND notice_id = #{id}
            AND admin_id = (SELECT admin_id FROM TB_STORE WHERE id =(SELECT store_id FROM TB_STORE_SESSION WHERE access_token=#{token}))
            AND store_id = (SELECT store_id FROM TB_STORE_SESSION WHERE access_token=#{token})
    </update>

</mapper>