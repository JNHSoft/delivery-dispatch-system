<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="kr.co.cntt.core.mapper.StoreMapper">

	<!--로그인 ID 확인 -->
	<select id="selectLoginStore" parameterType="kr.co.cntt.core.model.store.Store" resultType="String">
		SELECT login_id FROM TB_STORE
		WHERE 1=1
			AND login_id = #{loginId}
		<!--AND login_pw = #{loginPw}-->
		limit 1
	</select>


	<!--
		- login ID  및 Aceess 토근 값체크
		- expiry_datetime 이 NULL 이거나 금일 datetime 보다 큰 값
	-->
	<select id="selectStoreTokenCheck" parameterType="kr.co.cntt.core.model.store.Store" resultType="int">
		<![CDATA[
		SELECT
			COUNT(*)
		FROM TB_STORE A JOIN TB_STORE_SESSION B
		ON A.id = B.store_id
		WHERE 1=1
			AND A.login_id = #{loginId}
			AND B.access_token = #{accessToken}
			AND (expiry_datetime IS NULL OR expiry_datetime > now())
		]]>
	</select>


	<!-- insertStoreSession 토큰값을 넣어준다.-->
	<insert id="insertStoreSession" parameterType="kr.co.cntt.core.model.store.Store">
		<![CDATA[
		INSERT INTO TB_STORE_SESSION(store_id, access_token, created_datetime)
		SELECT
			id
			, #{accessToken}
			, now()
		FROM TB_STORE
		WHERE login_id = #{loginId}
		]]>
	</insert>


	<!--store 정보 조회-->
	<select id="getStoreInfo" parameterType="kr.co.cntt.core.model.store.Store" resultType="kr.co.cntt.core.model.store.Store">
		SELECT
		created_datetime
		, modified_datetime
		, last_access
		, admin_id
		, chat_user_id
		, login_id
		, login_pw
		, code
		, name
		, phone
		, store_name
		, ch_store_name
		, store_phone
		, address
		, detail_address
		, latitude
		, longitude
		, store_status
		, store_distance_sort
		, radius
		, assignment_status
		, assignment_limit
		, third_party
		, deleted
		FROM TB_STORE
		WHERE 1=1
		<choose>
			<when test="id != null and id != ''">
				<if test="(isAdmin != null and isAdmin != '') and isAdmin == 0">
					AND admin_id = (SELECT admin_id FROM TB_RIDER WHERE id = (SELECT rider_id FROM TB_RIDER_SESSION WHERE access_token = #{token}))
				</if>
				<if test="(isAdmin != null and isAdmin != '') and isAdmin == 1">
					AND admin_id = (SELECT admin_id FROM TB_ADMIN_SESSION WHERE access_token = #{token})
				</if>
				AND id = #{id}
			</when>
			<otherwise>
				AND admin_id = (SELECT admin_id FROM TB_STORE WHERE id = (SELECT store_id FROM TB_STORE_SESSION WHERE access_token = #{token}))
				AND id = (
				SELECT store_id
				FROM TB_STORE_SESSION
				WHERE access_token=#{accessToken}
				)
			</otherwise>
		</choose>
	</select>


	<!-- store 정보 수정 -->
	<update id="updateStoreInfo" parameterType="kr.co.cntt.core.model.store.Store">
		UPDATE TB_STORE
		SET
			modified_datetime = now()
			<if test="expirationDate != null and expirationDate != ''">
				, expiration_date = #{expirationDate}
			</if>

			<if test="lastAccess != null and lastAccess != ''">
				, last_access = #{lastAccess}
			</if>

			<if test="name != null and name != ''">
				, name = #{name}
			</if>

			<if test="phone != null and phone != ''">
				, phone = #{phone}
			</if>

			<if test="storeName != null and storeName != ''">
				, store_name = #{storeName}
			</if>

			<if test="chStoreName != null and chStoreName != ''">
				, ch_store_name = #{chStoreName}
			</if>

			<if test="storePhone != null and storePhone != ''">
				, store_phone = #{storePhone}
			</if>

			<if test="loginPw != null and loginPw != ''">
				, login_pw = #{loginPw}
			</if>

			<if test="email != null and email != ''">
				, email = #{email}
			</if>

			<if test="address != null and address != ''">
				, address = #{address}
			</if>

			<if test="detailAddress != null and detailAddress != ''">
				, detail_address = #{detailAddress}
			</if>

			<if test="chAddress != null and chAddress != ''">
				, ch_address = #{chAddress}
			</if>

			<if test="chDetailAddress != null and chDetailAddress != ''">
				, ch_detail_address = #{chDetailAddress}
			</if>

			<if test="latitude != null and latitude != ''">
				, latitude = #{latitude}
			</if>

			<if test="longitude != null  and longitude != ''">
				, longitude = #{longitude}
			</if>

			<if test="comment != null  and comment != ''">
				, comment = #{comment}
			</if>

			<if test="storeStatus != null  and storeStatus != ''">
				, store_status = #{storeStatus}
			</if>

			<if test="radius != null  and radius != ''">
				, radius = #{radius}
			</if>

			<if test="storeDistanceSort != null  and storeDistanceSort != ''">
				, store_distance_sort = #{storeDistanceSort}
			</if>

			<if test="assignmentStatus != null  and assignmentStatus != ''">
				, assignment_status = #{assignmentStatus}
			</if>

			<if test="assignmentLimit != null  and assignmentLimit != ''">
				, assignment_limit = #{assignmentLimit}
			</if>

			<if test="deleted != null  and deleted != ''">
				, deleted = #{deleted}
			</if>
		WHERE
			id = (
				SELECT store_id
				FROM TB_STORE_SESSION
				WHERE access_token=#{accessToken}
			)

	</update>


	<!-- selectStores -->
	<select id="selectStores" parameterType="kr.co.cntt.core.model.store.Store" resultType="kr.co.cntt.core.model.store.Store">
        SELECT
        	id
        	, latitude
        	, longitude
        FROM TB_STORE
        WHERE admin_id = (
        	SELECT admin_id FROM TB_STORE WHERE id = (
        		SELECT store_id FROM TB_STORE_SESSION WHERE access_token = #{accessToken}));
	</select>

</mapper>
 