<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "//mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="kr.co.cntt.core.mapper.StatisticsMapper">

    <select id="selectSubgroupStoreList" parameterType="kr.co.cntt.core.model.store.Store" resultType="java.util.Map">
        select   b.group_id             as groupId
                ,( select name from TB_GROUP where admin_id = b.admin_id and id = b.group_id )        as groupName
                ,b.subgroup_id          as subGroupid
                ,( select name from TB_SUBGROUP where admin_id = b.admin_id and group_id = b.group_id and id = b.subgroup_id )  as subGroupName
                ,a.brand_code           as brandCode
                ,( select cd_value from TB_CODE_MASTER where used_flag = 1 and title = 'brand_code' and code = a.brand_code ) as brandName
                ,a.id
                ,a.store_name           as storeName
        from     TB_STORE               as a
                ,TB_SUBGROUP_STORE_REL  as b
        where    a.id = b.store_id
        and      a.admin_id = b.admin_id
        and      a.deleted is null
        and      b.deleted is null
        <if test="role != null and role == 'ROLE_ADMIN'">
            and      a.admin_id = ( select admin_id from TB_ADMIN_SESSION where access_token = #{token} )
            and      b.subgroup_id in ( select subgroup_id from TB_SUBGROUP_STORE_REL where code = #{code} and deleted is null )
        </if>
        <if test="role != null and role == 'ROLE_STORE'">
            and      b.subgroup_id in ( select subgroup_id from TB_SUBGROUP_STORE_REL where store_id = ( select store_id from TB_STORE_SESSION where access_token = #{token} ) and deleted is null )
        </if>

    </select>

</mapper>
