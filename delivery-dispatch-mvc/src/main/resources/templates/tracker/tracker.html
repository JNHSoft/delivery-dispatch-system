<!DOCTYPE HTML>
<html xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout" layout:decorator="/trackerLayout">

<div class="tracker" layout:fragment="content">
	<div class="tracker-top">
		<div class="state">
			<span id="tNew" th:text="${#messages.msg('tracker.new')}" />
			<i class="fa fa-angle-right"></i>
			<span id="tAssign" th:text="${#messages.msg('tracker.assign')}"/>
			<i class="fa fa-angle-right"></i>
			<span id="tPickup" th:text="${#messages.msg('tracker.pickedup')}"/>
			<i class="fa fa-angle-right"></i>
			<span id="tComplete" th:text="${#messages.msg('tracker.completed')}"/>
		</div>
		<div class="clear">
			<div class="f_left t_yellow" th:text="${#messages.msg('tracker.guide')}"/>
			<div class="f_right">
				<span th:text="${#messages.msg('tracker.estimated.arrival.time')}"/>
				<span class="time"/>
			</div>
		</div>
	</div>
	<div id="map">
		<!-- 지도삽입 -->
	</div>
	<div class="tracker-bottom">
		<div>
			<p><span th:text="${#messages.msg('tracker.order.id')} + ' :'"/><span id="webId"></span></p>
			<p><span th:text="${#messages.msg('tracker.order.time')} + ' :'"/><span id="createdDatetime"/></p>
		</div>
		<div>
			<!--<p><span class="t_red" id="riderName"/> <span th:text="${#messages.msg('tracker.driver')}"/></p>-->
			<p><span th:text="${#messages.msg('tracker.destination')} + ' :'"/> <span id="detailAddress"/></p>
			<p th:text="${#messages.msg('tracker.dirver.guide')}"></p>
		</div>
		<div class="btn">
			<a href="#" id="riderSms"><img th:src="@{/resources/images/tracker/ICON_sms.png}" alt="" /></a>
			<a href="#" id="riderTel"><img th:src="@{/resources/images/tracker/ICON_call.png}" alt="" /></a>
		</div>
	</div>
</div>

<script layout:fragment="script" th:inline="javascript">
/*<![CDATA[*/
var createdDatetime = /*[[${tracker.createdDatetime}]]*/ 'createdDatetime';
var reservationDatetime = /*[[${tracker.reservationDatetime}]]*/ 'reservationDatetime';
var webOrderId = /*[[${tracker.webOrderId}]]*/ 'webOrderId';
var trackerStatus = /*[[${tracker.status}]]*/ 'status';
var latitude = /*[[${tracker.latitude}]]*/ 'latitude';
var longitude = /*[[${tracker.longitude}]]*/ 'longitude';
var cookingTime = /*[[${tracker.cookingTime}]]*/ 'cookingTime';
var storeName = /*[[${tracker.storeName}]]*/ 'storeName';
var storePhone = /*[[${tracker.storePhone}]]*/ 'storePhone';
var storeLatitude = /*[[${tracker.storeLatitude}]]*/ 'storeLatitude';
var storeLongitude = /*[[${tracker.storeLongitude}]]*/ 'storeLongitude';
var riderName = /*[[${tracker.riderName}]]*/ 'riderName';
var riderPhone = /*[[${tracker.riderPhone}]]*/ 'riderPhone';
var riderLatitude = /*[[${tracker.riderLatitude}]]*/ 'riderLatitude';
var riderLongitude = /*[[${tracker.riderLongitude}]]*/ 'riderLongitude';
var distance = /*[[${tracker.distance}]]*/ 'distance';
var trackerDetailAddress = /*[[${tracker.detailAddress}]]*/ 'trackerDetailAddress';

var remain_distance = /*[[#{tracker.remain.distance}]]*/ 'remain_distance';
var rest_time = /*[[#{tracker.rest.time}]]*/ 'rest_time';
var tracker_destination = /*[[#{tracker.destination}]]*/ 'tracker_destination';
var tracker_assign = /*[[#{tracker.assign}]]*/ 'tracker_assign';

console.log(webOrderId, status, storeName, storePhone, storeLatitude, storeLongitude, riderName, riderPhone, riderLatitude, riderLongitude, latitude, longitude, reservationDatetime);

var arriveTime = new Date(Date.parse(createdDatetime) + 1000 * 60 * cookingTime + 1000 * 60 * 30);

if(reservationDatetime){
    arriveTime = new Date(Date.parse(reservationDatetime));
}

$(document).ready(function(){
    if(self == top){
        location.href ="/error/error-tracker";
	}
});


window.onload = function() {
    if (cookingTime == null || cookingTime == '') {
        cookingTime = 0;
    }

    if (createdDatetime != null) {
        $('.time').text(arriveTime.getHours() + ':' + arriveTime.getMinutes());
    }

    $('.state > span').removeClass('on');

    if (trackerStatus == 0 || trackerStatus == 5) {
        $('#tNew').addClass('on');
    } else if (trackerStatus == 1) {
        $('#tAssign').addClass('on');
    } else if (trackerStatus == 2) {
        $('#tPickup').addClass('on');
    } else if(trackerStatus ==3){
        $('#tComplete').addClass('on');
    }

    $('#webId').text(webOrderId);

    $('#createdDatetime').text(createdDatetime);

    $('#detailAddress').text(trackerDetailAddress);
//    $('#riderName').text(riderName?riderName:"-");

    if(riderPhone){
        $('#riderSms').attr('href', 'sms:' + riderPhone);
        $('#riderTel').attr('href', 'tel:' + riderPhone);
	}else{
        $('#riderSms').css({ 'pointer-events': 'none' });
        $('#riderTel').css({ 'pointer-events': 'none' });
	}

}

function initMap() {
    var myLatlng = new google.maps.LatLng((riderLatitude&&trackerStatus!=1)?riderLatitude:storeLatitude, (riderLongitude&&trackerStatus!=1)?riderLongitude:storeLongitude);
    var storeLatlng = new google.maps.LatLng(storeLatitude, storeLongitude);
    var completedLatlng = new google.maps.LatLng(latitude, longitude);


    var map = new google.maps.Map(document.getElementById('map'), {
        zoom: 17,
        center: (trackerStatus!=3)?myLatlng:completedLatlng
    });

    var rendererOptions = {
        map: map,
        suppressMarkers: true
    };

    var directionsDisplay = new google.maps.DirectionsRenderer(rendererOptions);
    var directionsService = new google.maps.DirectionsService;



	function calculateAndDisplayRoute(directionsService, directionsDisplay) {

		var selectedMode = 'DRIVING';
//		var selectedMode = 'TRANSIT';
//      var selectedMode = 'WALKING';

		directionsService.route({
			origin: myLatlng,  // Haight.
			destination: completedLatlng,  // Ocean Beach.
//			origin: {lat: 37.580976, lng: 126.905788},  // Haight.
//			destination: {lat: 37.577655, lng: 126.907628},  // Ocean Beach.
			// Note that Javascript allows us to access the constant
			// using square brackets and a string value as its
			// "property."
			travelMode: google.maps.TravelMode[selectedMode],
            drivingOptions: {
                departureTime: new Date(),
                trafficModel: 'bestguess'
            }/*,
			waypoints: [{location : storeLatlng,
			    stopover:false}]*/
		}, function(response, status) {
			if (status == 'OK') {
                var route = response.routes[0].legs[0];
                console.log(response);

                var orderDistance = (route.distance).text;
                var durationInTraffic = ((route.duration_in_traffic).value)/60;

                var contentString = tracker_assign;

                if(riderLatitude&&trackerStatus!=1){
                    contentString = '<div class="map_info">'+
                        '<img src="/resources/images/tracker/ICON_helmet.png" alt="" /> '+
                        '<span class="t_blk" id="distance">' + remain_distance + orderDistance + '</span>'+
                        '<span class="t_blk">|</span> '+
                        '<span class="t_red">' + Math.round(durationInTraffic) + rest_time + '</span>'+
                        '</div>';
				}

                if(riderLatitude&&trackerStatus!=1){
                    var originMarker = new google.maps.Marker({
                        position: route.start_location,
                        map: map,
                        icon: '/resources/images/tracker/PIN_delivery.png',
                    });
				}else{
                    var originMarker = new google.maps.Marker({
                        position: route.start_location,
                        map: map,
                        label:{fontWeight: "bold",
                            text:storeName},
                        icon: '/resources/images/tracker/PIN_start.png',
                    });
				}


				var infowindow = new google.maps.InfoWindow({
					content: contentString
				});
				infowindow.open(map, originMarker);

                var destinationMarker = new google.maps.Marker({
                    position: route.end_location,
                    map: map,
                    label:{fontWeight: "bold",
                        text:tracker_destination},
                    icon: '/resources/images/tracker/PIN_destination.png',
                });

				if(riderLatitude&&trackerStatus!=1){
                    var marker = new google.maps.Marker({
                        position: storeLatlng,
                        map: map,
                        label:{fontWeight: "bold",
                            text:storeName},
                        icon: '/resources/images/tracker/PIN_start.png',
                    });
				}
				directionsDisplay.setDirections(response);
			} else {
				window.alert('Directions request failed due to ' + status);
			}
		});
	}

	directionsDisplay.setMap(map);
	if(trackerStatus!=3){
		calculateAndDisplayRoute(directionsService, directionsDisplay);
    }else {
        var compeltedMarker = new google.maps.Marker({
            position: completedLatlng,
            map: map,
            label:{fontWeight: "bold",
                text:tracker_destination},
            icon: '/resources/images/tracker/PIN_destination.png',
        });
	}
}
/*]]>*/
</script>

<script type="text/javascript" async="async" defer="defer" th:src="@{https://maps.googleapis.com/maps/api/js(key=AIzaSyAD8JKaMSAUG-TwI8dYTPfmwMbxYiVQelU,language=${#messages.msg('map.language')},region=${#messages.msg('map.region')},callback=initMap)}" layout:fragment="script2" />
</html>