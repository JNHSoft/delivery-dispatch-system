<!DOCTYPE HTML>
<html xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout" layout:decorator="/trackerLayout">

<div class="tracker" layout:fragment="content">
	<div class="tracker-top">
		<div class="state">
			<span id="tNew" th:text="${#messages.msg('tracker.new')}" />
			<i class="fa fa-angle-right"></i>
			<span id="tAssign" th:text="${#messages.msg('tracker.assign')}"/>
			<i class="fa fa-angle-right"></i>
			<span id="tPickup" th:text="${#messages.msg('tracker.pickedup')}"/>
			<i class="fa fa-angle-right"></i>
			<span id="tComplete" th:text="${#messages.msg('tracker.completed')}"/>
		</div>
		<div class="clear">
			<div class="f_left t_yellow" th:text="${#messages.msg('tracker.guide')}"/>
			<div class="f_right">
				<span th:text="${#messages.msg('tracker.estimated.arrival.time')}"/>
				<span class="time"/>
			</div>
		</div>
	</div>
	<div id="map">
		<!-- 지도삽입 -->
	</div>
	<div class="tracker-bottom">
		<div>
			<p><span th:text="${#messages.msg('tracker.order.id')} + ' :'"/><span id="webId"></span></p>
			<p><span th:text="${#messages.msg('tracker.order.time')} + ' :'"/><span id="createdDatetime"/></p>
		</div>
		<div>
			<p><span class="t_red" id="riderName"/> <span th:text="${#messages.msg('tracker.driver')}"/></p>
			<p th:text="${#messages.msg('tracker.dirver.guide')}"></p>
		</div>
		<div class="btn">
			<a href="#" id="riderSms"><img th:src="@{/resources/images/tracker/ICON_sms.png}" alt="" /></a>
			<a href="#" id="riderTel"><img th:src="@{/resources/images/tracker/ICON_call.png}" alt="" /></a>
		</div>
	</div>
</div>

<script layout:fragment="script" th:inline="javascript">
/*<![CDATA[*/
var createdDatetime = /*[[${tracker.createdDatetime}]]*/ 'createdDatetime';
var reservationDatetime = /*[[${tracker.reservationDatetime}]]*/ 'reservationDatetime';
var webOrderId = /*[[${tracker.webOrderId}]]*/ 'webOrderId';
var status = /*[[${tracker.status}]]*/ 'status';
var latitude = /*[[${tracker.latitude}]]*/ 'latitude';
var longitude = /*[[${tracker.longitude}]]*/ 'longitude';
var cookingTime = /*[[${tracker.cookingTime}]]*/ 'cookingTime';
var storeName = /*[[${tracker.storeName}]]*/ 'storeName';
var storePhone = /*[[${tracker.storePhone}]]*/ 'storePhone';
var storeLatitude = /*[[${tracker.storeLatitude}]]*/ 'storeLatitude';
var storeLongitude = /*[[${tracker.storeLongitude}]]*/ 'storeLongitude';
var riderName = /*[[${tracker.riderName}]]*/ 'riderName';
var riderPhone = /*[[${tracker.riderPhone}]]*/ 'riderPhone';
var riderLatitude = /*[[${tracker.riderLatitude}]]*/ 'riderLatitude';
var riderLongitude = /*[[${tracker.riderLongitude}]]*/ 'riderLongitude';
var distance = /*[[${tracker.distance}]]*/ 'distance';

var remain_distance = /*[[#{tracker.remain.distance}]]*/ 'remain_distance';
var rest_time = /*[[#{tracker.rest.time}]]*/ 'rest_time';

console.log(webOrderId, status, storeName, storePhone, storeLatitude, storeLongitude, riderName, riderPhone, riderLatitude, riderLongitude, latitude, longitude, reservationDatetime);

var arriveTime = new Date(Date.parse(createdDatetime) + 1000 * 60 * cookingTime + 1000 * 60 * 30);

if(reservationDatetime){
    arriveTime = new Date(Date.parse(reservationDatetime));
}

var date = new Date();
var tmpDate = new Date(arriveTime - date);

var contentString = '<div class="map_info">'+
    '<img src="./img/ICON_helmet.png" alt="" /> '+
    '<span class="t_blk" id="distance">' + remain_distance + distance + 'km</span>'+
    '<span class="t_blk">|</span> '+
    '<span class="t_red">' + parseInt(tmpDate.getTime() / (1000 * 60)) + rest_time + '</span>'+
    '</div>';

$(document).ready(function(){
    if(self == top){
        location.href ="/error/error-tracker";
	}
});


window.onload = function() {
    if (cookingTime == null || cookingTime == '') {
        cookingTime = 0;
    }

    if (createdDatetime != null) {
        $('.time').text(arriveTime.getHours() + ':' + arriveTime.getMinutes());
    }

    $('.state > span').removeClass('on');

    if (status == 0 || status == 5) {
        $('#tNew').addClass('on');
    } else if (status == 1) {
        $('#tAssign').addClass('on');
    } else if (status == 2) {
        $('#tPickup').addClass('on');
    } else if(status ==3){
        $('#tComplete').addClass('on');
    }

    $('#webId').text(webOrderId);

    $('#createdDatetime').text(createdDatetime);

    $('#riderName').text(riderName?riderName:"-");

    if(riderPhone){
        $('#riderSms').attr('href', 'sms:' + riderPhone);
        $('#riderTel').attr('href', 'tel:' + riderPhone);
	}else{
        $('#riderSms').css({ 'pointer-events': 'none' });
        $('#riderTel').css({ 'pointer-events': 'none' });
	}

}

function initMap() {
    var directionsDisplay = new google.maps.DirectionsRenderer();
    var directionsService = new google.maps.DirectionsService;

    var myLatlng = new google.maps.LatLng(riderLatitude?riderLatitude:storeLatitude, riderLongitude?riderLongitude:storeLongitude);
	var map = new google.maps.Map(document.getElementById('map'), {
    zoom: 17,
    center: myLatlng
	});

	function calculateAndDisplayRoute(directionsService, directionsDisplay) {

		var selectedMode = 'DRIVING';
//		var selectedMode = 'TRANSIT';
//      var selectedMode = 'WALKING';

		directionsService.route({
			origin: {lat: parseFloat(storeLatitude), lng: parseFloat(storeLongitude)},  // Haight.
			destination: {lat: parseFloat(latitude), lng: parseFloat(longitude)},  // Ocean Beach.
//			origin: {lat: 37.580976, lng: 126.905788},  // Haight.
//			destination: {lat: 37.577655, lng: 126.907628},  // Ocean Beach.
			// Note that Javascript allows us to access the constant
			// using square brackets and a string value as its
			// "property."
			travelMode: google.maps.TravelMode[selectedMode]
		}, function(response, status) {
			if (status == 'OK') {
				directionsDisplay.setDirections(response);
			} else {
				window.alert('Directions request failed due to ' + status);
			}
		});
	}

	directionsDisplay.setMap(map);
	calculateAndDisplayRoute(directionsService, directionsDisplay);

    var infowindow = new google.maps.InfoWindow({
        content: contentString
    });

    var markerImg = '/resources/images/tracker/PIN_delivery.png';
    var marker = new google.maps.Marker({
        position: myLatlng,
        map: map,
        icon: markerImg,
    });

    infowindow.open(map, marker);
}
/*]]>*/
</script>

<script type="text/javascript" async="async" defer="defer" th:src="@{https://maps.googleapis.com/maps/api/js(key=AIzaSyAD8JKaMSAUG-TwI8dYTPfmwMbxYiVQelU,language=${#messages.msg('map.language')},region=${#messages.msg('map.region')},callback=initMap)}" layout:fragment="script2" />
</html>