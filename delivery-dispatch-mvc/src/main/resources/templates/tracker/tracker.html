<!DOCTYPE HTML>
<html xmlns:th="//www.thymeleaf.org" xmlns:layout="//www.ultraq.net.nz/thymeleaf/layout" layout:decorator="/trackerLayout">

<div class="tracker" layout:fragment="content">
	<div class="tracker-top">
		<div class="state">
			<span id="tNew" class="step1" th:text="${#messages.msg('tracker.new')}" />
			<i class="fa fa-angle-right"></i>
			<span id="tAssign" class="step2" th:text="${#messages.msg('tracker.assign')}"/>
			<i class="fa fa-angle-right"></i>
			<span id="tPickup" class="step3" th:text="${#messages.msg('tracker.pickedup')}"/>
			<i class="fa fa-angle-right"></i>
			<span id="tComplete" class="step4" th:text="${#messages.msg('tracker.completed')}"/>
		</div>
	</div>
	<div class="visual_area">
		<!-- 지도삽입 -->
	</div>
	<div id="map" class="mapCtrl" hidden="hidden"></div>
	<div class="tracker-bottom">
		<table>
			<colgroup>
				<col style="width:12%"/>
				<col />
				<col style="width:12%"/>
				<col style="width:15%"/>
			</colgroup>
			<tbody>
			<tr>
				<th scope="row">外送門市</th>
				<td id="storeName">-</td>
				<th scope="row" class="t_red">預計到達時間</th>
				<td class="t_red bold" id="reservedTime">-</td>
			</tr>
			<tr>
				<th scope="row">門市地址</th>
				<td rowspan="3" id="storeAddress">-</td>
			</tr>
			</tbody>
		</table>
	</div>
</div>

<script layout:fragment="script" th:inline="javascript">
/*<![CDATA[*/
var createdDatetime = /*[[${tracker.createdDatetime}]]*/ 'createdDatetime';
var reservationDatetime = /*[[${tracker.reservationDatetime}]]*/ 'reservationDatetime';
var webOrderId = /*[[${tracker.webOrderId}]]*/ 'webOrderId';
var trackerStatus = /*[[${tracker.status}]]*/ 'trackerStatus';
var latitude = /*[[${tracker.latitude}]]*/ 'latitude';
var longitude = /*[[${tracker.longitude}]]*/ 'longitude';
var cookingTime = /*[[${tracker.cookingTime}]]*/ 'cookingTime';
var storeName = /*[[${tracker.storeName}]]*/ 'storeName';
var storePhone = /*[[${tracker.storePhone}]]*/ 'storePhone';
var storeLatitude = /*[[${tracker.storeLatitude}]]*/ 'storeLatitude';
var storeLongitude = /*[[${tracker.storeLongitude}]]*/ 'storeLongitude';
var riderName = /*[[${tracker.riderName}]]*/ 'riderName';
var riderPhone = /*[[${tracker.riderPhone}]]*/ 'riderPhone';
var riderLatitude = /*[[${tracker.riderLatitude}]]*/ 'riderLatitude';
var riderLongitude = /*[[${tracker.riderLongitude}]]*/ 'riderLongitude';
var distance = /*[[${tracker.distance}]]*/ 'distance';
var trackerDetailAddress = /*[[${tracker.detailAddress}]]*/ 'trackerDetailAddress';
var storeDetailAddress = /*[[${tracker.storeDetailAddress}]]*/ 'storeDetailAddress';
var encParam = /*[[${encParam}]]*/ 'encParam';

var remain_distance = /*[[#{tracker.remain.distance}]]*/ 'remain_distance';
var rest_time = /*[[#{tracker.rest.time}]]*/ 'rest_time';
var tracker_destination = /*[[#{tracker.destination}]]*/ 'tracker_destination';
var tracker_assign = /*[[#{tracker.assign}]]*/ 'tracker_assign';

//console.log(webOrderId, status, storeName, storePhone, storeLatitude, storeLongitude, riderName, riderPhone, riderLatitude, riderLongitude, latitude, longitude, reservationDatetime);
var map;
var marker = [];
var directionsDisplay;
var directionsService;
var infowindow = [];
var checkTime;

$(document).ready(function(){
    if(self == top){
        location.href ="/error/error-tracker";
    }
    if (reservationDatetime && trackerStatus != 2) {
        var arriveTime = new Date(Date.parse(reservationDatetime));
        $('#reservedTime').text(setHourMin(arriveTime.getHours()) + ':' + setHourMin(arriveTime.getMinutes()));
        var nowTime = new Date();
        checkTime = arriveTime.getTime()-nowTime.getTime();
    }

    if(checkTime-1800*1000>0) {
        setTimeout('window.location.reload()',checkTime-1800*1000);
    }

    if(trackerStatus==2){
        $(".mapCtrl").attr("id","");
        $(".visual_area").attr("id","map");
        initMap();
        setInterval('calculateAndDisplayRoute(directionsService, directionsDisplay)', 30000);
    }

    if((trackerStatus == 0 || trackerStatus == 5 || trackerStatus == 1)){
        setInterval('window.location.reload()', 30000);
    }
    /*if(trackerStatus == 3){
        window.location.reload()
    }*/
//    setInterval('window.location.reload()', 3000);

});

function initMap() {
    map = new google.maps.Map(document.getElementById('map'), {
        zoom: 14,
        center: new google.maps.LatLng((parseFloat(latitude)+parseFloat(storeLatitude))/2 + '', (parseFloat(longitude)+parseFloat(storeLongitude))/2 + ''),
		styles: [
            {
                "featureType": "administrative",
                "elementType": "geometry.fill",
                "stylers": [
                    {
                        "color": "#d6e2e6"
                    }
                ]
            },
            {
                "featureType": "administrative",
                "elementType": "geometry.stroke",
                "stylers": [
                    {
                        "color": "#cddbe0"
                    }
                ]
            },
            {
                "featureType": "administrative",
                "elementType": "labels.text.fill",
                "stylers": [
                    {
                        "color": "#7492a8"
                    }
                ]
            },
            {
                "featureType": "administrative.neighborhood",
                "elementType": "labels.text.fill",
                "stylers": [
                    {
                        "lightness": 25
                    }
                ]
            },
            {
                "featureType": "administrative.land_parcel",
                "elementType": "labels",
                "stylers": [
                    {
                        "visibility": "off"
                    }
                ]
            },
            {
                "featureType": "landscape.man_made",
                "elementType": "geometry.fill",
                "stylers": [
                    {
                        "color": "#d6e2e6"
                    }
                ]
            },
            {
                "featureType": "landscape.man_made",
                "elementType": "geometry.stroke",
                "stylers": [
                    {
                        "color": "#cddbe0"
                    }
                ]
            },
            {
                "featureType": "landscape.natural",
                "elementType": "geometry.fill",
                "stylers": [
                    {
                        "color": "#dae6eb"
                    }
                ]
            },
            {
                "featureType": "landscape.natural",
                "elementType": "labels.text.fill",
                "stylers": [
                    {
                        "color": "#7492a8"
                    }
                ]
            },
            {
                "featureType": "landscape.natural.terrain",
                "elementType": "all",
                "stylers": [
                    {
                        "visibility": "off"
                    }
                ]
            },
            {
                "featureType": "poi",
                "elementType": "geometry.fill",
                "stylers": [
                    {
                        "color": "#d6e2e6"
                    }
                ]
            },
            {
                "featureType": "poi",
                "elementType": "labels.text.fill",
                "stylers": [
                    {
                        "color": "#588ca4"
                    }
                ]
            },
            {
                "featureType": "poi",
                "elementType": "labels.icon",
                "stylers": [
                    {
                        "saturation": -100
                    }
                ]
            },
            {
                "featureType": "poi.park",
                "elementType": "geometry.fill",
                "stylers": [
                    {
                        "color": "#cae7a8"
                    }
                ]
            },
            {
                "featureType": "poi.park",
                "elementType": "geometry.stroke",
                "stylers": [
                    {
                        "color": "#bae6a1"
                    }
                ]
            },
            {
                "featureType": "poi.sports_complex",
                "elementType": "geometry.fill",
                "stylers": [
                    {
                        "color": "#c6e8b3"
                    }
                ]
            },
            {
                "featureType": "poi.sports_complex",
                "elementType": "geometry.stroke",
                "stylers": [
                    {
                        "color": "#bae6a1"
                    }
                ]
            },
            {
                "featureType": "road",
                "elementType": "labels.text.fill",
                "stylers": [
                    {
                        "color": "#41626b"
                    }
                ]
            },
            {
                "featureType": "road",
                "elementType": "labels.icon",
                "stylers": [
                    {
                        "saturation": -45
                    },
                    {
                        "lightness": 10
                    },
                    {
                        "visibility": "off"
                    }
                ]
            },
            {
                "featureType": "road.highway",
                "elementType": "geometry.fill",
                "stylers": [
                    {
                        "color": "#f7fdff"
                    }
                ]
            },
            {
                "featureType": "road.highway",
                "elementType": "geometry.stroke",
                "stylers": [
                    {
                        "color": "#beced4"
                    }
                ]
            },
            {
                "featureType": "road.arterial",
                "elementType": "geometry.fill",
                "stylers": [
                    {
                        "color": "#eef3f5"
                    }
                ]
            },
            {
                "featureType": "road.arterial",
                "elementType": "geometry.stroke",
                "stylers": [
                    {
                        "color": "#cddbe0"
                    }
                ]
            },
            {
                "featureType": "road.local",
                "elementType": "geometry.fill",
                "stylers": [
                    {
                        "color": "#edf3f5"
                    }
                ]
            },
            {
                "featureType": "road.local",
                "elementType": "geometry.stroke",
                "stylers": [
                    {
                        "color": "#cddbe0"
                    }
                ]
            },
            {
                "featureType": "road.local",
                "elementType": "labels",
                "stylers": [
                    {
                        "visibility": "off"
                    }
                ]
            },
            {
                "featureType": "transit",
                "elementType": "labels.icon",
                "stylers": [
                    {
                        "saturation": -70
                    }
                ]
            },
            {
                "featureType": "transit.line",
                "elementType": "labels.text.fill",
                "stylers": [
                    {
                        "color": "#588ca4"
                    }
                ]
            },
            {
                "featureType": "transit.station",
                "elementType": "labels.text.fill",
                "stylers": [
                    {
                        "color": "#008cb5"
                    }
                ]
            },
            {
                "featureType": "transit.station.airport",
                "elementType": "geometry.fill",
                "stylers": [
                    {
                        "saturation": -100
                    },
                    {
                        "lightness": -5
                    }
                ]
            },
            {
                "featureType": "water",
                "elementType": "geometry.fill",
                "stylers": [
                    {
                        "color": "#a6cbe3"
                    }
                ]
            }
        ]
    });

    var rendererOptions = {
        map: map,
        suppressMarkers: true,//길찾기시 마커 재적용하려면 필요
        preserveViewport : true,//길찾기시 맵 중심 수동지정하려면 필요
        polylineOptions : {visible: false}//길찾기시 선 제거
    };

    directionsDisplay = new google.maps.DirectionsRenderer(rendererOptions);
    directionsService = new google.maps.DirectionsService;

    if(trackerStatus == 2){
        directionsDisplay.setMap(map);
//        calculateAndDisplayRoute(directionsService, directionsDisplay);
    }
}

function calculateAndDisplayRoute(directionsService, directionsDisplay) {
    $.ajax({
        url:"/trackerInfo",
        type:'get',
        data : {
            encParam : encParam
        },
        dataType : 'json',
        success : function(data) {
//            console.log(data);
            trackerStatus = data.status;
            if(data.status==3){
                window.location.reload();
			}
            if(data.status==2){
                for (var i = 0; i < marker.length; i++) {
                    marker[i].setMap(null);
                }
                marker=[];

                for (var i = 0; i < infowindow.length; i++) {
                    infowindow[i].close();
                }
                infowindow=[];

                var selectedMode = 'DRIVING';
                //		var selectedMode = 'TRANSIT';
                //      var selectedMode = 'WALKING';

                directionsService.route({
                    origin: new google.maps.LatLng(data.riderLatitude, data.riderLongitude),  // Haight.
                    destination: new google.maps.LatLng(data.latitude, data.longitude),
                    // Note that Javascript allows us to access the constant
                    // using square brackets and a string value as its
                    // "property."
                    travelMode: google.maps.TravelMode[selectedMode],
                    drivingOptions: {
                        departureTime: new Date(),
                        trafficModel: 'bestguess'
                    }/*,
			waypoints: [{location : storeLatlng,
			    stopover:false}]*/
                }, function(response, status) {
                    if (status == 'OK') {
                        var route = response.routes[0].legs[0];
//                        console.log(response);

                        var orderDistance = (route.distance).text;
                        var durationInTraffic = ((route.duration_in_traffic).value)/60;

                        var contentString = '<div class="map_info">'+
                            '<img src="/resources/images/tracker/ICON_helmet.png" alt="" /> '+
                            '<span class="t_blk" id="distance">' + remain_distance + orderDistance + '</span>'+
                            '<span class="t_blk">|</span> '+
                            '<span class="t_red">' + Math.round(durationInTraffic) + rest_time + '</span>'+
                            '</div>';

                        var arriveTrafficTime = new Date((new Date).getTime()+route.duration_in_traffic.value*1000);

                        $('#reservedTime').text(setHourMin(arriveTrafficTime.getHours()) + ':' + setHourMin(arriveTrafficTime.getMinutes()));

                        marker[0] = new google.maps.Marker({
                            position: route.start_location,
                            map: map,
                            icon: {
                                url: data.longitude>data.riderLongitude?'/resources/images/tracker/pin_moto_right.png':'/resources/images/tracker/pin_moto_left.png',
                                scaledSize: new google.maps.Size(40, 27)
                            }
                        });

                        infowindow = new google.maps.InfoWindow({
                            content: contentString
                        });
                        infowindow.open(map, marker[0]);

                        marker[1] = new google.maps.Marker({
                            position: route.end_location,
                            map: map,
                            /*label:{fontWeight: "bold",
                                text:tracker_destination},*/
                            icon: {
                                url:'/resources/images/tracker/pin_home.png',
                                scaledSize: new google.maps.Size(30, 40)
							}
                        });

                        marker[2] = new google.maps.Marker({
                            position: new google.maps.LatLng(data.storeLatitude, data.storeLongitude),
                            map: map,
                            /*label:{fontWeight: "bold", text:data.storeName},*/
                            icon: {
                                url:'/resources/images/tracker/pin_store.png',
                                scaledSize: new google.maps.Size(40, 28)
                            }
                        });
                        directionsDisplay.setDirections(response);
                    } else {
                        window.alert('Directions request failed due to ' + status);
                    }
                });
			}
        }/*,
        error : function (request,status,error) {
            alert("code:"+request.status+"\n"+"message:"+request.responseText+"\n"+"error:"+error);
        }*/
    })
}



function setHourMin(time1) {
//    console.log(time1);
    if(time1==0){
        return "00";
	}else{
        return (time1+'').length>1?time1:'0'+time1;
	}
}

window.onload = function() {
	if(storeName){
        $('#storeName').text(storeName);
	}

    $('.state > span').removeClass('on');

//	console.log(checkTime);
//    console.log(distance);
    if ((trackerStatus == 0 || trackerStatus == 5) && checkTime > 1800*1000) {
        $('#tNew').addClass('on');
        $('.visual_area').html('<div class="loading"></div>');
    } else if ((trackerStatus == 0 || trackerStatus == 5 || trackerStatus == 1)&& checkTime <= 1800*1000) {
        $('#tNew').addClass('on chk');
        $('#tAssign').addClass('on');
        $('.visual_area').html('<div class="gps_loading"></div>');
    } else if (trackerStatus == 2) {
        $('#tNew').addClass('on chk');
        $('#tAssign').addClass('on chk');
        $('#tPickup').addClass('on');
        calculateAndDisplayRoute(directionsService, directionsDisplay);
    } else if(trackerStatus ==3) {
        $('#tNew').addClass('on chk');
        $('#tAssign').addClass('on chk');
        $('#tPickup').addClass('on chk');
        $('#tComplete').addClass('on');
        $('#reservedTime').text('-');
        $(".visual_area").html('<p class="tit_wh">請享用熱騰騰<br/>的美味餐點</p>');
    }

	if(storeDetailAddress) {
        $('#storeAddress').text(storeDetailAddress);
	}
//    $('#riderName').text(riderName?riderName:"-");
}

/*]]>*/
</script>

<script type="text/javascript" defer="defer" th:src="@{https://maps.googleapis.com/maps/api/js(key=AIzaSyAD8JKaMSAUG-TwI8dYTPfmwMbxYiVQelU,language=${#messages.msg('map.language')},region=${#messages.msg('map.region')},callback=initMap)}" layout:fragment="script2" />
</html>