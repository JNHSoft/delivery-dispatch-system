<!DOCTYPE HTML>
<html xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout" layout:decorator="/trackerLayout">

<div class="tracker" layout:fragment="content">
	<div class="tracker-top">
		<div class="state">
			<span id="tNew" class="step1" th:text="${#messages.msg('tracker.new')}" />
			<i class="fa fa-angle-right"></i>
			<span id="tAssign" class="step2" th:text="${#messages.msg('tracker.assign')}"/>
			<i class="fa fa-angle-right"></i>
			<span id="tPickup" class="step3" th:text="${#messages.msg('tracker.pickedup')}"/>
			<i class="fa fa-angle-right"></i>
			<span id="tComplete" class="step4" th:text="${#messages.msg('tracker.completed')}"/>
		</div>
	</div>
	<div class="visual_area">
		<!-- 지도삽입 -->
	</div>
	<div id="map" class="mapCtrl" hidden="hidden"></div>
	<div class="tracker-bottom">
		<table>
			<colgroup>
				<col style="width:12%"/>
				<col />
				<col style="width:12%"/>
				<col style="width:15%"/>
			</colgroup>
			<tbody>
			<tr>
				<th scope="row">外送門市</th>
				<td id="storeName">-</td>
				<th scope="row" class="t_red">預計到達時間</th>
				<td class="t_red bold" id="reservedTime">-</td>
			</tr>
			<tr>
				<th scope="row">門市地址</th>
				<td rowspan="3" id="storeAddress">-</td>
			</tr>
			</tbody>
		</table>
	</div>
</div>

<script layout:fragment="script" th:inline="javascript">
/*<![CDATA[*/
var createdDatetime = /*[[${tracker.createdDatetime}]]*/ 'createdDatetime';
var reservationDatetime = /*[[${tracker.reservationDatetime}]]*/ 'reservationDatetime';
var webOrderId = /*[[${tracker.webOrderId}]]*/ 'webOrderId';
var trackerStatus = /*[[${tracker.status}]]*/ 'status';
var latitude = /*[[${tracker.latitude}]]*/ 'latitude';
var longitude = /*[[${tracker.longitude}]]*/ 'longitude';
var cookingTime = /*[[${tracker.cookingTime}]]*/ 'cookingTime';
var storeName = /*[[${tracker.storeName}]]*/ 'storeName';
var storePhone = /*[[${tracker.storePhone}]]*/ 'storePhone';
var storeLatitude = /*[[${tracker.storeLatitude}]]*/ 'storeLatitude';
var storeLongitude = /*[[${tracker.storeLongitude}]]*/ 'storeLongitude';
var riderName = /*[[${tracker.riderName}]]*/ 'riderName';
var riderPhone = /*[[${tracker.riderPhone}]]*/ 'riderPhone';
var riderLatitude = /*[[${tracker.riderLatitude}]]*/ 'riderLatitude';
var riderLongitude = /*[[${tracker.riderLongitude}]]*/ 'riderLongitude';
var distance = /*[[${tracker.distance}]]*/ 'distance';
var trackerDetailAddress = /*[[${tracker.detailAddress}]]*/ 'trackerDetailAddress';
var storeDetailAddress = /*[[${tracker.storeDetailAddress}]]*/ 'storeDetailAddress';

var remain_distance = /*[[#{tracker.remain.distance}]]*/ 'remain_distance';
var rest_time = /*[[#{tracker.rest.time}]]*/ 'rest_time';
var tracker_destination = /*[[#{tracker.destination}]]*/ 'tracker_destination';
var tracker_assign = /*[[#{tracker.assign}]]*/ 'tracker_assign';

//console.log(webOrderId, status, storeName, storePhone, storeLatitude, storeLongitude, riderName, riderPhone, riderLatitude, riderLongitude, latitude, longitude, reservationDatetime);

$(document).ready(function(){
    if(self == top){
        location.href ="/error/error-tracker";
	}
	if(trackerStatus==2){
        $(".mapCtrl").attr("id","");
        $(".visual_area").attr("id","map");
	}
});


window.onload = function() {
    if (!cookingTime) {
        cookingTime = 0;
    }

	if(storeName){
        $('#storeName').text(storeName);
	}

    if (reservationDatetime && trackerStatus != 2) {
        var arriveTime = new Date(Date.parse(reservationDatetime));
        $('#reservedTime').text(arriveTime.getHours() + ':' + arriveTime.getMinutes());
    }

    $('.state > span').removeClass('on');

    if (trackerStatus == 0 || trackerStatus == 5) {
        $('#tNew').addClass('on');
    } else if (trackerStatus == 1) {
        $('#tNew').addClass('on');
        $('#tAssign').addClass('on');
    } else if (trackerStatus == 2) {
        $('#tNew').addClass('on');
        $('#tAssign').removeClass('step2 on');
        $('#tAssign').addClass('step1 on');
        $('#tPickup').addClass('on');
    } else if(trackerStatus ==3){
        $('#tNew').addClass('on');
        $('#tAssign').removeClass('step2 on');
        $('#tAssign').addClass('step1 on');
        $('#tPickup').removeClass('step3 on');
        $('#tPickup').addClass('step1 on');
        $('#tComplete').addClass('on');
        $('#reservedTime').text('-');
    }

	if(storeDetailAddress){
        $('#storeAddress').text(storeDetailAddress);
	}
//    $('#riderName').text(riderName?riderName:"-");

}

function initMap() {
    var myLatlng = new google.maps.LatLng(riderLatitude, riderLongitude);
    var storeLatlng = new google.maps.LatLng(storeLatitude, storeLongitude);
    var completedLatlng = new google.maps.LatLng(latitude, longitude);


    var map = new google.maps.Map(document.getElementById('map'), {
        zoom: 17,
        center: myLatlng
    });

    var rendererOptions = {
        map: map,
        suppressMarkers: true
    };

    var directionsDisplay = new google.maps.DirectionsRenderer(rendererOptions);
    var directionsService = new google.maps.DirectionsService;



	function calculateAndDisplayRoute(directionsService, directionsDisplay) {

		var selectedMode = 'DRIVING';
//		var selectedMode = 'TRANSIT';
//      var selectedMode = 'WALKING';

		directionsService.route({
			origin: myLatlng,  // Haight.
			destination: completedLatlng,  // Ocean Beach.
//			origin: {lat: 37.580976, lng: 126.905788},  // Haight.
//			destination: {lat: 37.577655, lng: 126.907628},  // Ocean Beach.
			// Note that Javascript allows us to access the constant
			// using square brackets and a string value as its
			// "property."
			travelMode: google.maps.TravelMode[selectedMode],
            drivingOptions: {
                departureTime: new Date(),
                trafficModel: 'bestguess'
            }/*,
			waypoints: [{location : storeLatlng,
			    stopover:false}]*/
		}, function(response, status) {
			if (status == 'OK') {
                var route = response.routes[0].legs[0];
                console.log(response);

                var orderDistance = (route.distance).text;
                var durationInTraffic = ((route.duration_in_traffic).value)/60;

				var contentString = '<div class="map_info">'+
					'<img src="/resources/images/tracker/ICON_helmet.png" alt="" /> '+
					'<span class="t_blk" id="distance">' + remain_distance + orderDistance + '</span>'+
					'<span class="t_blk">|</span> '+
					'<span class="t_red">' + Math.round(durationInTraffic) + rest_time + '</span>'+
					'</div>';

                var arriveTrafficTime = new Date((new Date).getTime()+route.duration_in_traffic.value*1000);
                $('#reservedTime').text(arriveTrafficTime.getHours() + ':' + arriveTrafficTime.getMinutes());

                var originMarker = new google.maps.Marker({
					position: route.start_location,
					map: map,
					icon: {
					    url:'/resources/images/tracker/PIN_scooter.png',
                        scaledSize: new google.maps.Size(40, 27),
						}
				});


				var infowindow = new google.maps.InfoWindow({
					content: contentString
				});
				infowindow.open(map, originMarker);

                var destinationMarker = new google.maps.Marker({
                    position: route.end_location,
                    map: map,
                    label:{fontWeight: "bold",
                        text:tracker_destination},
                    icon: {url:'/resources/images/tracker/PIN_destination.png'}
                });

				var marker = new google.maps.Marker({
					position: storeLatlng,
					map: map,
					label:{fontWeight: "bold", text:storeName},
					icon: {
					    url:'/resources/images/tracker/PIN_start.png',
                        scaledSize: new google.maps.Size(40, 28),
					}
				});
				directionsDisplay.setDirections(response);
			} else {
				window.alert('Directions request failed due to ' + status);
			}
		});
	}
	if(trackerStatus == 2){
        directionsDisplay.setMap(map);
        calculateAndDisplayRoute(directionsService, directionsDisplay);
	}
}
/*]]>*/
</script>

<script type="text/javascript" async="async" defer="defer" th:src="@{https://maps.googleapis.com/maps/api/js(key=AIzaSyAD8JKaMSAUG-TwI8dYTPfmwMbxYiVQelU,language=${#messages.msg('map.language')},region=${#messages.msg('map.region')},callback=initMap)}" layout:fragment="script2" />
</html>